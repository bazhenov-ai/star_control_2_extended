<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ó–≤—ë–∑–¥–Ω–∞—è –∫–∞—Ä—Ç–∞ Star Control 2</title>
  <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: #111;
        color: #ddd;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        padding: 12px;
      }
      .main-container {
        display: flex;
        flex: 1;
        gap: 12px;
        min-height: 0;
        min-width: 0; /* ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è Firefox */
      }
      #mapContainer {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: black;
        border: 1px solid #222;
        min-width: 0; /* ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è Firefox */
      }
      #starMap {
        display: block;
        background-color: black;
        image-rendering: pixelated;
        cursor: crosshair;
      }
      #sidePanel {
        width: 260px;
        flex: 0 0 260px; /* ‚Üê –∏–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è Firefox */
        min-width: 0; /* ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è Firefox */
        padding: 12px;
        border: 1px solid #222;
        background: #0d0d0d;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }
      #controls {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      label {
        font-size: 14px;
        display: block;
        margin-bottom: 6px;
      }
      select, button {
        padding: 6px 8px;
        font-size: 14px;
      }
      .sectionTitle {
        font-size: 13px;
        color: #bbb;
        margin-bottom: 6px;
      }
      #currentDate {
        font-size: 14px;
        color: #fff;
        margin-bottom: 0px;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
      }
      .completed {
        color: #00ff00;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
      }

      .victory-content {
          background: linear-gradient(135deg, #0d3b1a, #0a2e14);
          margin: 15% auto;
          padding: 30px;
          border: 2px solid #00ff44;
          border-radius: 15px;
          width: 60%;
          max-width: 500px;
          text-align: center;
          box-shadow: 0 0 30px #00ff44;
          color: #fff;
          font-family: Arial, sans-serif;
          position: relative;
          animation: glow 2s ease-in-out infinite alternate;
      }

      .warning-content {
          background: linear-gradient(135deg, #3b2a0d, #2e220a);
          margin: 15% auto;
          padding: 30px;
          border: 2px solid #ffa500;
          border-radius: 15px;
          width: 60%;
          max-width: 500px;
          text-align: center;
          box-shadow: 0 0 30px #ffa500;
          color: #fff;
          font-family: Arial, sans-serif;
          position: relative;
          animation: glow-warning 2s ease-in-out infinite alternate;
          }

      .defeat-content {
          background: linear-gradient(135deg, #3b1a1a, #2e1414);
          margin: 15% auto;
          padding: 30px;
          border: 2px solid #ff0000;
          border-radius: 15px;
          width: 60%;
          max-width: 500px;
          text-align: center;
          box-shadow: 0 0 30px #ff0000;
          color: #fff;
          font-family: Arial, sans-serif;
          position: relative;
          animation: glow-defeat 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
          from { box-shadow: 0 0 20px #00ff44; }
          to { box-shadow: 0 0 40px #00ff44, 0 0 60px #00ff44; }
      }

      @keyframes glow-warning {
          from { box-shadow: 0 0 20px #ffa500; }
          to { box-shadow: 0 0 40px #ffa500, 0 0 60px #ffa500; }
      }

      @keyframes glow-defeat {
          from { box-shadow: 0 0 20px #ff0000; }
          to { box-shadow: 0 0 40px #ff0000, 0 0 60px #ff0000; }
      }

      .victory-title {
          font-size: 28px;
          color: #00ff44;
          margin-bottom: 20px;
          text-shadow: 0 0 10px #00ff44;
      }

      .warning-title {
          font-size: 28px;
          color: #ffa500;
          margin-bottom: 20px;
          text-shadow: 0 0 10px #ffa500;
      }

      .defeat-title {
          font-size: 28px;
          color: #ff0000;
          margin-bottom: 20px;
          text-shadow: 0 0 10px #ff0000;
      }

      .victory-message {
          font-size: 20px;
          margin-bottom: 25px;
          line-height: 1.5;
      }

      .victory-button {
          background: #00cc33;
          color: #000;
          border: none;
          padding: 12px 30px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 18px;
          margin: 10px 2px;
          cursor: pointer;
          border-radius: 8px;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .victory-button:hover {
          background: #00ff44;
          box-shadow: 0 0 15px #00ff44;
          transform: scale(1.05);
      }

      .next-button {
          background: #00cc33;
          color: #000;
          border: none;
          padding: 12px 30px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 10px 2px;
          cursor: pointer;
          border-radius: 8px;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .next-button:hover {
          background: #00ff44;
          box-shadow: 0 0 15px #00ff44;
          transform: scale(1.05);
      }

      #textPosition {
        display: none;
      }

      .warning-button {
          background: #ffcc00;
          color: #000;
          border: none;
          padding: 12px 30px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 10px 2px;
          cursor: pointer;
          border-radius: 7px;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .warning-button:hover {
          background: #ffcc4d;
          box-shadow: 0 0 15px #ffa500;
          transform: scale(1.05);
      }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="mapContainer">
      <canvas id="starMap"></canvas>
    </div>

    <div id="sidePanel">
      <div id="controls">
        <div>
          <div id="currentDate" style="color: #FFFF00;">17 —Ñ–µ–≤—Ä–∞–ª—è 2155 –≥–æ–¥–∞</div>
        </div>

<div style="display: flex; gap: 10px; width: 100%;">
  <button id="nextTurnButton" class="next-button" style="flex: 1;">1 —Ö–æ–¥</button>
  <button id="multiTurnButton" class="warning-button" style="flex: 1;">${MULTI_TURN_COUNT} —Ö–æ–¥–æ–≤</button>
</div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="createNewAlliance">
            <label for="createNewAlliance" style="margin:0;font-size:14px;">–°–æ–∑–¥–∞–Ω–∏–µ –ù–æ–≤–æ–≥–æ –ê–ª—å—è–Ω—Å–∞</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithZoqFotPik">
            <label for="allianceWithZoqFotPik" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Zoq-Fot-Pik</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithOrz">
            <label for="allianceWithOrz" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Orz</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithSpathi">
            <label for="allianceWithSpathi" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Spathi</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∞–ª—å—è–Ω—Å–∞ —Å Black Squadron -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithBlackSquadron">
            <label for="allianceWithBlackSquadron" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Black Squadron <a href="bss.txt" style="color: #FFFF00;" target="_blank"><b>???</b></a></label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –ø–æ—á–∏–Ω–∫–∏ Mother-Ark -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="motherArkRepair">
            <label for="motherArkRepair" style="margin:0;font-size:14px;">–ü–æ—á–∏–Ω–∫–∞ Mother-Ark</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithThraddash">
            <label for="allianceWithThraddash" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Thraddash</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ñ–ª–æ—Ç–∞ Syreen -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="syreenFleetReturn">
            <label for="syreenFleetReturn" style="margin:0;font-size:14px;">–í–æ–∑–≤—Ä–∞—Ç —Ñ–ª–æ—Ç–∞ Syreen</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∑–∞—Å–∞–¥—ã Mycon -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="myconAmbush">
            <label for="myconAmbush" style="margin:0;font-size:14px;">–ó–∞—Å–∞–¥–∞ –¥–ª—è Mycon</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithSupoxUtwig">
            <label for="allianceWithSupoxUtwig" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Supox –∏ Utwig</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="shofixtiRevival">
            <label for="shofixtiRevival" style="margin:0;font-size:14px;">–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ Shofixti</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è —Ä–µ–≤–æ–ª—é—Ü–∏–∏ Yehat -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="yehatRebellion">
            <label for="yehatRebellion" style="margin:0;font-size:14px;">–†–µ–≤–æ–ª—é—Ü–∏—è Yehat</label>
          </div>
        </div>

        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceWithChmmr">
            <label for="allianceWithChmmr" style="margin:0;font-size:14px;">–ê–ª—å—è–Ω—Å —Å Chmmr</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è —Å–Ω—è—Ç–∏—è Earthling Slave Shield -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="earthlingShieldRemoval">
            <label for="earthlingShieldRemoval" style="margin:0;font-size:14px;">Slave Shield Earthling</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è —Å–Ω—è—Ç–∏—è Unzervalt Slave Shield -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="unzervaltShieldRemoval">
            <label for="unzervaltShieldRemoval" style="margin:0;font-size:14px;">Slave Shield Unzervalt</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è —Å–Ω—è—Ç–∏—è Syreen Slave Shield -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="syreenShieldRemoval">
            <label for="syreenShieldRemoval" style="margin:0;font-size:14px;">Slave Shield Syreen</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è —Å–Ω—è—Ç–∏—è Spathi Slave Shield -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="spathiShieldRemoval">
            <label for="spathiShieldRemoval" style="margin:0;font-size:14px;">Slave Shield Spathi</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∞—Ç–∞–∫–∏ Thraddash -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="thraddashAttack">
            <label for="thraddashAttack" style="margin:0;font-size:14px;">–ê—Ç–∞–∫–∞ Thraddash</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∞—Ç–∞–∫–∏ Ilwrath -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="ilwrathAttack">
            <label for="ilwrathAttack" style="margin:0;font-size:14px;">–ê—Ç–∞–∫–∞ Ilwrath</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∞—Ç–∞–∫–∏ Supox –∏ Utwig -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="supoxUtwigAttack">
            <label for="supoxUtwigAttack" style="margin:0;font-size:14px;">–ê—Ç–∞–∫–∞ Supox –∏ Utwig</label>
          </div>
        </div>

        <!-- –ù–æ–≤—ã–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞ -->
        <div>
          <div class="checkbox-container">
            <input type="checkbox" id="allianceAttack">
            <label for="allianceAttack" style="margin:0;font-size:14px;">–ê—Ç–∞–∫–∞ –ê–ª—å—è–Ω—Å–∞</label>
          </div>
        </div>

        <div>
          <div class="sectionTitle">–°—Ñ–µ—Ä—ã –≤–ª–∏—è–Ω–∏—è</div>
          <select id="sphereType">
            <option value="none">–ù–µ—Ç</option>
            <option value="newSpheres" selected>–ò–≥—Ä–∞</option>
            <option value="initialNewSpheres">Star Control 2</option>
            <option value="oldSpheres">Star Control 1</option>
          </select>
        </div>

        <div>
          <select id="textPosition">
            <option value="auto" selected>–ê–≤—Ç–æ</option>
            <option value="top">–°–≤–µ—Ä—Ö—É</option>
            <option value="counterclockwise">–ü—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π (45¬∞)</option>
            <option value="clockwise">–ü–æ —á–∞—Å–æ–≤–æ–π (45¬∞)</option>
          </select>
        </div>

        <div>
          <div class="sectionTitle" style="color: #FFFF00;"><b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b></div>
          <div style="font-size:13px;color:#bbb;line-height:1.3;">
            –°—Ñ–µ—Ä–∞ –ù–æ–≤–æ–≥–æ –ê–ª—å—è–Ω—Å–∞ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π –º–æ—â–∏ –≤—Å–µ—Ö —á–ª–µ–Ω–æ–≤ –ê–ª—å—è–Ω—Å–∞.
          </div>
          <div class="sectionTitle" style="color: #FFFF00;"><a href="https://github.com/bazhenov-ai" style="color: #00FF00;" target="_blank">https://github.com/bazhenov-ai</a></div>
          <div class="sectionTitle"><a href="https://bazhenov-ai.github.io/star_control_2_extended/LICENSE" style="color: #00FF00;" target="_blank">CC0-1.0 license - public domain</a></div>
          <div class="sectionTitle" style="color: #FFFF00;">–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–æ—Å—Ç–æ—è–Ω–∏–µ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã -->
  <div id="victoryModal" class="modal">
      <div class="victory-content">
          <div class="victory-title">üéâ –ü–û–ë–ï–î–ê! üéâ</div>
          <div class="victory-message" id="victoryMessage"></div>
          <button class="victory-button" onclick="closeVictoryModal()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
  <div id="warningModal" class="modal">
      <div class="warning-content">
          <div class="warning-title">‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï! ‚ö†Ô∏è</div>
          <div class="victory-message" id="warningMessage"></div>
          <button class="victory-button" onclick="closeWarningModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Ä–∞–∂–µ–Ω–∏—è -->
  <div id="defeatModal" class="modal">
      <div class="defeat-content">
          <div class="defeat-title">üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï! üíÄ</div>
          <div class="victory-message" id="defeatMessage"></div>
<!--          <button class="victory-button" onclick="closeDefeatModal()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button> -->
          <a href="index.html" class="victory-button" target="_top">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
      </div>
  </div>

  <!-- –í–Ω–µ—à–Ω–∏–µ —Ñ–∞–π–ª—ã —Å–æ –∑–≤–µ–∑–¥–∞–º–∏ –∏ —Å—Ñ–µ—Ä–∞–º–∏ –≤–ª–∏—è–Ω–∏—è -->
  <script src="stars.js"></script>
  <script src="spheres.js"></script>

  <script>
    // ========== –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò ==========

    // === –ò–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ ===
    // === –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ —Ö–æ–¥–æ–≤ ===
    const DAYS_PER_TURN = 7; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∑–∞ –æ–¥–∏–Ω —Ö–æ–¥
    const MULTI_TURN_COUNT = 10;
    const DAYS_UNTIL_SPATHI_ESCAPE = 10; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ –±–µ–≥—Å—Ç–≤–∞ Spathi
    const DAYS_UNTIL_PKUNK_REUNION = 120; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk –ø–æ—Å–ª–µ —Ä–µ–≤–æ–ª—é—Ü–∏–∏ Yehat

    // === –ú–∞—Ä—à —Å–º–µ—Ä—Ç–∏ ===
    const KOHRAH_VICTORY_WARNING = "Kohr-Ah –ø–æ–±–µ–¥–∏–ª–∏ –≤ –≤–æ–π–Ω–µ –¥–æ–∫—Ç—Ä–∏–Ω. –ï—Å–ª–∏ –Ω–µ –∞—Ç–∞–∫–æ–≤–∞—Ç—å –∏—Ö —Å–µ–π—á–∞—Å, —Å–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ –æ–Ω–∏ –ø–æ–ª—É—á–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ Sa-Matra, –∏ —Ç–æ–≥–¥–∞ —É–∂–µ –Ω–∏ —á—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç –∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å!";
    const DEFEAT_MESSAGE = "Kohr-Ah –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ Sa-Matra. Sa-Matra –æ–±–ª–∞–¥–∞–µ—Ç —Ç–∞–∫–æ–π –º–æ—â—å—é, —á—Ç–æ –∫–∞–∫ –±—ã –º–∞–ª–æ –≤—Ä–∞–≥–æ–≤ –Ω–∏ –æ—Å—Ç–∞–ª–æ—Å—å, —Ç–µ–ø–µ—Ä—å —É–∂–µ –Ω–∏ —á—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç –∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.";
    const DAYS_UNTIL_DEATH_MARCH_STARTS = 30;

    // === –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ ===
    const VICTORY_MESSAGE = "–°–≤–µ—Ä—à–∏–ª–æ—Å—å! –ê–ª—å—è–Ω—Å –ø–æ–±–µ–¥–∏–ª! Ur-Quan –∏ Kohr-Ah –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –∏—Ö —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—ã –∫–æ–ª–µ–Ω–µ–π!";

    // === –ù–∞–∑–≤–∞–Ω–∏—è —Å—Ñ–µ—Ä ===
    const BLACK_SQUADRON_NAME = "Black Squadron";
    const NEW_ALLIANCE_NAME = "New Alliance";

    // === –ù–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–¥–∏—É—Å—ã —Å—Ñ–µ—Ä ===
    const EARTHLING_INITIAL_RADIUS = 20;
    const NEW_ALLIANCE_INITIAL_RADIUS = 20;
    const YEHAY_REBEL_RADIUS = 53;
    const MMRNMHRM_REVIVED_RADIUS = 10;
    const SYREEN_INITIAL_RADIUS = 10;
    const SHOFIXTI_REVIVED_RADIUS = 10;
    const CHMMR_INITIAL_RADIUS = 125;
    const YEHAY_REBEL_AFTER_REUNION_RADIUS = 100.3;

    // === –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–æ–≤ –∑–∞ —Ö–æ–¥ ===
    let UR_QUAN_RADIUS_CHANGE = -0.02;
    let KOHR_AH_RADIUS_CHANGE = -0.011;
    let SHOFIXTI_RADIUS_CHANGE = 0.01;
    let MMRNMHRM_AREA_CHANGE = 1.79;

    // === –£–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–æ–≤ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —â–∏—Ç–æ–≤ ===
    const SYREEN_SHIELD_REMOVAL_RADIUS_INCREASE = 10;
    const EARTHLING_SHIELD_REMOVAL_RADIUS_INCREASE = 40;

    // === Spathi Slave Shield Constants ===
    const SPATHI_SLAVE_SHIELD_RADIUS = 20;

    // === Unzervalt Slave Shield Constants ===
    const UNZERVALT_SLAVE_SHIELD_RADIUS = 40;
    const UNZERVALT_SPHERE_NAME = "Unzervalt";
    const UNZERVALT_CENTER_POSITION = [334.5, 193.1];

    // === –ë–æ–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
    const SPHERE_MOVEMENT_SPEED = 2;
    const SPHERE_DAMAGE_SPEED = 100;

    // –ê—Ç–∞–∫–∞ Thraddash
    const THRADDASH_ATTACK_DISTANCE = 160;
    const THRADDASH_ATTACK_DAMAGE = 45;

    // –ê—Ç–∞–∫–∞ Ilwrath
    const ILWRATH_ATTACK_DISTANCE = 120;
    const ILWRATH_ATTACK_DAMAGE = 0;

    // –ê—Ç–∞–∫–∞ Supox –∏ Utwig
    const SUPOX_UTWIG_ATTACK_DISTANCE = 140;
    const SUPOX_UTWIG_ATTACK_DAMAGE = 40;
    const SUPOX_DAMAGE_REDUCTION_FACTOR = 3.3;

    // –ó–∞—Å–∞–¥–∞ Mycon
    const MYCON_AMBUSH_TARGET = [685.8, 57.7];
    const MYCON_AMBUSH_DAMAGE = 60;

    // –ê—Ç–∞–∫–∞ –ê–ª—å—è–Ω—Å–∞
    const ALLIANCE_ATTACK_DISTANCE = 60;
    const HIERARCHY_DAMAGE_FACTOR = 1.6;
    const MIN_ALLY_RADIUS = 5;

    // === –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
    const BASE_MAP_SIZE = 1000;
    const GRID_DIVISIONS = 20;
    const STAR_HOVER_RADIUS = 12;
    const STAR_LABEL_OFFSET = 10;
    const SPHERE_LABEL_OFFSET = 10;
    const STAR_HIGHLIGHT_MULTIPLIER = 4;
    const STAR_NORMAL_MULTIPLIER = 3;

    // –¶–≤–µ—Ç–∞
    const COLOR_NEW_ALLIANCE = '#00FF00';
    const COLOR_BLACK_SQUADRON = '#6f6f6f';
    const COLOR_EARTHLING = '#FFFF00';

    // === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è ===
    const MIN_SCALE = 0.2;
    const MAX_SCALE = 5;
    const ZOOM_STEP = 0.0005;

    // === –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ñ–µ—Ä ===
    const SYREEN_INITIAL_POSITION = [412.5, 377.0];

    // –¶–≤–µ—Ç–∞ –∑–≤–µ–∑–¥
    const colors = {
      Blue: ['#0000FF'],
      White: ['#FFFFFF'],
      Green: ['#00FF00'],
      Yellow: ['#FFFF00'],
      Orange: ['#FFA500'],
      Red: ['#FF0000']
    };

    // ========== –†–ï–§–ê–ö–¢–û–†–ò–ù–ì: –†–ê–ó–î–ï–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –°–§–ï–† ==========

    // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ñ–µ—Ä (–Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è)
    let initialSphereData = {
      none: [],
      newSpheres: [],  // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SC2
      oldSpheres: []   // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SC1
    };

    // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ñ–µ—Ä (–∏–∑–º–µ–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–≥—Ä—ã)
    let gameSpheres = [];

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤ New Alliance
    let newAllianceAllies = {
      ZoqFotPik: false,
      Orz: false,
      Spathi: false,
      Thraddash: false,
      Syreen: false,
      SupoxUtwig: false,
      Shofixti: false,
      Chmmr: false,
      BlackSquadron: false,
      YehatRebel: false,
      Mmrnmhrm: false,
      Unzervalt: false
    };

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–∞—Ç—ã –∑–∞–∫–ª—é—á–µ–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Spathi
    let spathiAllianceDate = null;

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ —Ä–µ–≤–æ–ª—é—Ü–∏–∏ Yehat
    let yehatRebellionDate = null;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Ç–∞–∫–∏ Thraddash
    let thraddashAttackState = {
      active: false,
      phase: 'moving',
      originalThraddashPosition: null,
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Ç–∞–∫–∏ Ilwrath
    let ilwrathAttackState = {
      active: false,
      phase: 'moving',
      originalIlwrathPosition: null,
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Ç–∞–∫–∏ Supox –∏ Utwig
    let supoxUtwigAttackState = {
      active: false,
      phase: 'moving',
      originalSupoxPosition: null,
      originalUtwigPosition: null,
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—Å–∞–¥—ã Mycon
    let myconAmbushState = {
      active: false,
      phase: 'moving',
      originalMyconPosition: null,
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk
    let pkunkReunionState = {
      active: false,
      phase: 'moving',
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞
    let allianceAttackState = {
      active: false,
      alliesInAttack: [],
      daysInCurrentPhase: 0
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏
    let deathMarchState = {
        active: false,
        warningShown: false,
        daysUntilDeathMarch: 0,
        countdownActive: false
    };

    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
    try {
      if (window.sphereDataFromFile) {
        initialSphereData = window.sphereDataFromFile;
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–≥—Ä–æ–≤—ã–µ —Å—Ñ–µ—Ä—ã –∫–æ–ø–∏–µ–π –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö SC2
        gameSpheres = JSON.parse(JSON.stringify(initialSphereData.newSpheres));
      }
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ñ–µ—Ä:", e);
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
    let currentDate = new Date(2155, 1, 17);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    function formatDate(date) {
      const months = [
        '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
      ];
      const day = date.getDate();
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      return `${day} ${month} ${year} –≥–æ–¥–∞`;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã
    function updateDateDisplay() {
      document.getElementById('currentDate').textContent = formatDate(currentDate);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
    function checkCriticalEvents() {
        const victoryModal = document.getElementById('victoryModal');
        const defeatModal = document.getElementById('defeatModal');
        const warningModal = document.getElementById('warningModal');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        if (victoryModal.style.display === 'block' ||
            defeatModal.style.display === 'block' ||
            warningModal.style.display === 'block') {
            return true;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å—Ñ–µ—Ä
        const newAllianceSphere = gameSpheres.find(sphere => sphere.name === NEW_ALLIANCE_NAME);
        if (!newAllianceSphere || newAllianceSphere.size <= 0) {
            return true;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        if (allianceAttackState.active) {
            return true;
        }

        return false;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ö–æ–¥–æ–≤
    document.getElementById('multiTurnButton').addEventListener('click', function() {
        for (let i = 0; i < MULTI_TURN_COUNT; i++) {
            nextTurn();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ö–æ–¥–∞
            if (checkCriticalEvents()) {
                console.log(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ—Å–ª–µ ${i + 1} —Ö–æ–¥–æ–≤`);
                break;
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    document.getElementById('multiTurnButton').textContent = `${MULTI_TURN_COUNT} —Ö–æ–¥–æ–≤`;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–±–µ–¥—ã
    function checkVictoryCondition() {
        const urQuanSphere = gameSpheres.find(sphere => sphere.name === 'Ur-Quan');
        const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');

        // –ï—Å–ª–∏ –æ–±–µ —Å—Ñ–µ—Ä—ã —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã (–Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ gameSpheres)
        if (!urQuanSphere && !kohrAhSphere) {
            showVictoryMessage();
            return true;
        }
        return false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ
    function showVictoryMessage() {
        const victoryModal = document.getElementById('victoryModal');
        const victoryMessage = document.getElementById('victoryMessage');

        if (victoryModal && victoryMessage) {
            victoryMessage.textContent = VICTORY_MESSAGE;
            victoryModal.style.display = 'block';

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ Kohr-Ah
    function showWarningMessage() {
        const warningModal = document.getElementById('warningModal');
        const warningMessage = document.getElementById('warningMessage');

        if (warningModal && warningMessage) {
            warningMessage.textContent = KOHRAH_VICTORY_WARNING;
            warningModal.style.display = 'block';

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if (navigator.vibrate) {
                navigator.vibrate([300, 100, 300, 100, 300]);
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏
    function showDefeatMessage() {
        const defeatModal = document.getElementById('defeatModal');
        const defeatMessage = document.getElementById('defeatMessage');

        if (defeatModal && defeatMessage) {
            defeatMessage.textContent = DEFEAT_MESSAGE;
            defeatModal.style.display = 'block';

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500]);
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–±–µ–¥—ã
    function closeVictoryModal() {
        const victoryModal = document.getElementById('victoryModal');
        if (victoryModal) {
            victoryModal.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    function closeWarningModal() {
        const warningModal = document.getElementById('warningModal');
        if (warningModal) {
            warningModal.style.display = 'none';
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—Ñ–µ—Ä Ur-Quan –∏ Kohr-Ah
        UR_QUAN_RADIUS_CHANGE = 0;
        KOHR_AH_RADIUS_CHANGE = 0;

        console.log("–£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—Ñ–µ—Ä Ur-Quan –∏ Kohr-Ah –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
    function closeDefeatModal() {
        const defeatModal = document.getElementById('defeatModal');
        if (defeatModal) {
            defeatModal.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏
    function checkDeathMarchConditions() {
        // –ï—Å–ª–∏ –∞—Ç–∞–∫–∞ –∞–ª—å—è–Ω—Å–∞ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä—à —Å–º–µ—Ä—Ç–∏
        if (allianceAttackState.active) {
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª –ª–∏ 2159 –≥–æ–¥
        if (currentDate.getFullYear() >= 2159 && !deathMarchState.active) {
            deathMarchState.active = true;
            console.log("–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ú–∞—Ä—à –°–º–µ—Ä—Ç–∏ - 2159 –≥–æ–¥");
        }

        // –ï—Å–ª–∏ –º–∞—Ä—à —Å–º–µ—Ä—Ç–∏ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ Kohr-Ah > Ur-Quan
        if (deathMarchState.active && !deathMarchState.warningShown) {
            const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');
            const urQuanSphere = gameSpheres.find(sphere => sphere.name === 'Ur-Quan');

            // –ï—Å–ª–∏ Kohr-Ah –±–æ–ª—å—à–µ Ur-Quan, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            if (kohrAhSphere && urQuanSphere && kohrAhSphere.size > urQuanSphere.size) {
                showWarningMessage();
                deathMarchState.warningShown = true;
                deathMarchState.daysUntilDeathMarch = DAYS_UNTIL_DEATH_MARCH_STARTS;
                deathMarchState.countdownActive = true;
                console.log("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ Kohr-Ah –ø–æ–∫–∞–∑–∞–Ω–æ");
            }
        }

        // –ï—Å–ª–∏ –æ—Ç—Å—á–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω, —É–º–µ–Ω—å—à–∞–µ–º –¥–Ω–∏
        if (deathMarchState.countdownActive) {
            deathMarchState.daysUntilDeathMarch -= DAYS_PER_TURN;
            console.log(`–î–æ –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏ –æ—Å—Ç–∞–ª–æ—Å—å: ${deathMarchState.daysUntilDeathMarch} –¥–Ω–µ–π`);

            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
            if (deathMarchState.daysUntilDeathMarch <= 0) {
                showDefeatMessage();
                deathMarchState.countdownActive = false;
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ñ–µ—Ä
    function removeDestroyedSpheres() {
        for (let i = gameSpheres.length - 1; i >= 0; i--) {
            if (gameSpheres[i].size <= 0) {
                console.log(`–£–¥–∞–ª–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ ${gameSpheres[i].name} —Å —Ä–∞–¥–∏—É—Å–æ–º ${gameSpheres[i].size}`);
                gameSpheres.splice(i, 1);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –ø–æ–±–µ–¥—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ñ–µ—Ä
        checkVictoryCondition();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–¥–∏—É—Å–∞ New Alliance –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–¥–∏—É—Å–æ–≤ —Å–æ—é–∑–Ω–∏–∫–æ–≤
    function calculateNewAllianceRadius() {
      let totalArea = 0;

      const earthlingSphere = gameSpheres.find(sphere => sphere.name === 'Earthling');
      if (earthlingSphere) {
        totalArea += Math.PI * Math.pow(earthlingSphere.size, 2);
      }

      if (newAllianceAllies.ZoqFotPik) {
        const zoqSphere = gameSpheres.find(sphere => sphere.name === 'Zoq-Fot-Pik');
        if (zoqSphere) {
          totalArea += Math.PI * Math.pow(zoqSphere.size, 2);
        }
      }

      if (newAllianceAllies.Orz) {
        const orzSphere = gameSpheres.find(sphere => sphere.name === 'Orz');
        if (orzSphere) {
          totalArea += Math.PI * Math.pow(orzSphere.size, 2);
        }
      }

      if (newAllianceAllies.Spathi) {
        const spathiSphere = gameSpheres.find(sphere => sphere.name === 'Spathi');
        if (spathiSphere) {
          totalArea += Math.PI * Math.pow(spathiSphere.size, 2);
        }
      }

      if (newAllianceAllies.Thraddash) {
        const thraddashSphere = gameSpheres.find(sphere => sphere.name === 'Thraddash');
        if (thraddashSphere) {
          totalArea += Math.PI * Math.pow(thraddashSphere.size, 2);
        }
      }

      if (newAllianceAllies.Syreen) {
        const syreenSphere = gameSpheres.find(sphere => sphere.name === 'Syreen');
        if (syreenSphere) {
          totalArea += Math.PI * Math.pow(syreenSphere.size, 2);
        }
      }

      if (newAllianceAllies.SupoxUtwig) {
        const supoxSphere = gameSpheres.find(sphere => sphere.name === 'Supox');
        const utwigSphere = gameSpheres.find(sphere => sphere.name === 'Utwig');
        if (supoxSphere) {
          totalArea += Math.PI * Math.pow(supoxSphere.size, 2);
        }
        if (utwigSphere) {
          totalArea += Math.PI * Math.pow(utwigSphere.size, 2);
        }
      }

      if (newAllianceAllies.Shofixti) {
        const shofixtiSphere = gameSpheres.find(sphere => sphere.name === 'Shofixti');
        if (shofixtiSphere) {
          totalArea += Math.PI * Math.pow(shofixtiSphere.size, 2);
        }
      }

      if (newAllianceAllies.Chmmr) {
        const chmmrSphere = gameSpheres.find(sphere => sphere.name === 'Chmmr');
        if (chmmrSphere) {
          totalArea += Math.PI * Math.pow(chmmrSphere.size, 2);
        }
      }

      if (newAllianceAllies.BlackSquadron) {
        const blackSquadronSphere = gameSpheres.find(sphere => sphere.name === BLACK_SQUADRON_NAME);
        if (blackSquadronSphere) {
          totalArea += Math.PI * Math.pow(blackSquadronSphere.size, 2);
        }
      }

      if (newAllianceAllies.YehatRebel) {
        const yehatRebelSphere = gameSpheres.find(sphere => sphere.name === 'Yehat Rebel');
        if (yehatRebelSphere) {
          totalArea += Math.PI * Math.pow(yehatRebelSphere.size, 2);
        }
      }

      if (newAllianceAllies.Mmrnmhrm) {
        const mmrnmhrmSphere = gameSpheres.find(sphere => sphere.name === 'Mmrnmhrm');
        if (mmrnmhrmSphere) {
          totalArea += Math.PI * Math.pow(mmrnmhrmSphere.size, 2);
        }
      }

      if (newAllianceAllies.Unzervalt) {
        const unzervaltSphere = gameSpheres.find(sphere => sphere.name === UNZERVALT_SPHERE_NAME);
        if (unzervaltSphere) {
          totalArea += Math.PI * Math.pow(unzervaltSphere.size, 2);
        }
      }

      return Math.sqrt(totalArea / Math.PI);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ñ–µ—Ä—ã New Alliance –≤ –¥–∞–Ω–Ω—ã—Ö
    function updateNewAllianceSphere() {
      let newAllianceSphere = gameSpheres.find(sphere => sphere.name === NEW_ALLIANCE_NAME);

      if (newAllianceSphere) {
        newAllianceSphere.size = calculateNewAllianceRadius();
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
    function initializeCheckboxes() {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        const allCheckboxes = document.querySelectorAll('#sidePanel input[type="checkbox"]');

        // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –∏—Ö, –∫—Ä–æ–º–µ "createNewAlliance"
        allCheckboxes.forEach(checkbox => {
            if (checkbox.id !== 'createNewAlliance') {
                checkbox.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å

                // –ú–µ–Ω—è–µ–º —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    label.style.color = '#666'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
                    label.style.fontStyle = 'italic';
                }
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–µ–≥—Å—Ç–≤–∞ Spathi
    function checkAutoSpathiEscape() {
      if (spathiAllianceDate && newAllianceAllies.Spathi) {
        const timeDiff = currentDate.getTime() - spathiAllianceDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));

        if (daysDiff >= DAYS_UNTIL_SPATHI_ESCAPE) {
          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –±–µ–≥—Å—Ç–≤–æ Spathi
          createSpathiEscape();

          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∞–ª—å—è–Ω—Å —Å Black Squadron
          const blackSquadronCheckbox = document.getElementById('allianceWithBlackSquadron');
          const blackSquadronLabel = document.querySelector('label[for="allianceWithBlackSquadron"]');
          if (blackSquadronCheckbox && blackSquadronLabel) {
            blackSquadronCheckbox.disabled = false;
            blackSquadronLabel.style.color = '';
            blackSquadronLabel.style.fontStyle = '';
          }
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk
    function checkAutoPkunkReunion() {
      if (yehatRebellionDate && !pkunkReunionState.active) {
        const timeDiff = currentDate.getTime() - yehatRebellionDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));

        if (daysDiff >= DAYS_UNTIL_PKUNK_REUNION) {
          const pkunkSphere = gameSpheres.find(sphere => sphere.name === 'Pkunk');
          if (pkunkSphere) {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Pkunk
            startPkunkReunion();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
            yehatRebellionDate = null;
          } else {
            // –ï—Å–ª–∏ —Å—Ñ–µ—Ä—ã Pkunk –Ω–µ—Ç, —Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
            yehatRebellionDate = null;
          }
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞
    function startAllianceAttack() {
      const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');

      if (!kohrAhSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ Kohr-Ah –¥–ª—è –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞");
        return;
      }

      allianceAttackState.active = true;
      allianceAttackState.daysInCurrentPhase = 0;
      allianceAttackState.alliesInAttack = [];

      // –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–î–ò–£–°–û–í –ü–†–ò –ê–¢–ê–ö–ï –ê–õ–¨–Ø–ù–°–ê
      SHOFIXTI_RADIUS_CHANGE = 0;
      MMRNMHRM_AREA_CHANGE = 0;

      // –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—á–µ—Ç –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
      if (deathMarchState.countdownActive) {
        deathMarchState.countdownActive = false;
        console.log("–û—Ç—Å—á–µ—Ç –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑-–∑–∞ –∞—Ç–∞–∫–∏ –∞–ª—å—è–Ω—Å–∞");
      }

      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤ –¥–ª—è –∞—Ç–∞–∫–∏
      const allyNames = [
        'Earthling', 'Zoq-Fot-Pik', 'Orz', 'Spathi', 'Thraddash', 'Syreen',
        'Supox', 'Utwig', 'Shofixti', 'Chmmr', BLACK_SQUADRON_NAME,
        'Yehat Rebel', 'Mmrnmhrm', UNZERVALT_SPHERE_NAME
      ];

      for (const allyName of allyNames) {
        const allySphere = gameSpheres.find(sphere => sphere.name === allyName);
        if (allySphere && allySphere.size > 0) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç —Å–æ—é–∑–Ω–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã–º –≤ –∞–ª—å—è–Ω—Å–µ
          let isActive = false;
          switch(allyName) {
            case 'Earthling': isActive = true; break;
            case 'Zoq-Fot-Pik': isActive = newAllianceAllies.ZoqFotPik; break;
            case 'Orz': isActive = newAllianceAllies.Orz; break;
            case 'Spathi': isActive = newAllianceAllies.Spathi; break;
            case 'Thraddash': isActive = newAllianceAllies.Thraddash; break;
            case 'Syreen': isActive = newAllianceAllies.Syreen; break;
            case 'Supox':
            case 'Utwig': isActive = newAllianceAllies.SupoxUtwig; break;
            case 'Shofixti': isActive = newAllianceAllies.Shofixti; break;
            case 'Chmmr': isActive = newAllianceAllies.Chmmr; break;
            case BLACK_SQUADRON_NAME: isActive = newAllianceAllies.BlackSquadron; break;
            case 'Yehat Rebel': isActive = newAllianceAllies.YehatRebel; break;
            case 'Mmrnmhrm': isActive = newAllianceAllies.Mmrnmhrm; break;
            case UNZERVALT_SPHERE_NAME: isActive = newAllianceAllies.Unzervalt; break;
          }

          if (isActive) {
            allianceAttackState.alliesInAttack.push({
              name: allyName,
              originalPosition: { x: allySphere.x, y: allySphere.y },
              phase: 'moving',
              sphere: allySphere
            });
          }
        }
      }

      console.log(`–ù–∞—á–∞–ª–æ –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞ —Å ${allianceAttackState.alliesInAttack.length} —Å–æ—é–∑–Ω–∏–∫–∞–º–∏`);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ç–∞–∫–∏ –ê–ª—å—è–Ω—Å–∞
    function processAllianceAttack() {
      if (!allianceAttackState.active) return;

      const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');
      const urQuanSphere = gameSpheres.find(sphere => sphere.name === 'Ur-Quan');

      // –ï—Å–ª–∏ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —Å—Ñ–µ—Ä—ã —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º –∞—Ç–∞–∫—É
      if ((!kohrAhSphere || kohrAhSphere.size <= 0) && (!urQuanSphere || urQuanSphere.size <= 0)) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤ –Ω–∞ –±–∞–∑—É
        for (const ally of allianceAttackState.alliesInAttack) {
          if (ally.phase !== 'returning' && ally.phase !== 'returned') {
            ally.phase = 'returning';
          }
        }
      }

      let activeAllies = 0;

      for (const ally of allianceAttackState.alliesInAttack) {
        if (ally.phase === 'destroyed') continue;

        const allySphere = ally.sphere;

        // –ï—Å–ª–∏ —Å–æ—é–∑–Ω–∏–∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (allySphere.size <= 0) {
          ally.phase = 'destroyed';
          continue;
        }

        if (ally.phase === 'moving') {
          // –î–≤–∏–∂–µ–Ω–∏–µ –∫ Kohr-Ah
          if (!kohrAhSphere || kohrAhSphere.size <= 0) {
            ally.phase = 'returning';
            continue;
          }

          const dx = kohrAhSphere.x - allySphere.x;
          const dy = kohrAhSphere.y - allySphere.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance <= ALLIANCE_ATTACK_DISTANCE) {
            ally.phase = 'fighting';
          } else {
            const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
            const ratio = moveDistance / distance;
            allySphere.x += dx * ratio;
            allySphere.y += dy * ratio;
          }
        }
        else if (ally.phase === 'fighting') {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ —Ä–∞–¥–∏—É—Å —Å–æ—é–∑–Ω–∏–∫–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º
          if (allySphere.size < MIN_ALLY_RADIUS) {
            allySphere.size = MIN_ALLY_RADIUS; // –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
            ally.phase = 'returning';
            continue;
          }

          // –ë–æ–π —Å –ò–µ—Ä–∞—Ä—Ö–∏–µ–π
          const allyArea = Math.PI * Math.pow(allySphere.size, 2);
          const damageArea = SPHERE_DAMAGE_SPEED * DAYS_PER_TURN;

          // –°–æ—é–∑–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–Ω
          const newAllyArea = Math.max(0, allyArea - damageArea);
          allySphere.size = Math.sqrt(newAllyArea / Math.PI);

          // –í—Ä–∞–≥–∏ –ø–æ–ª—É—á–∞—é—Ç —É—Ä–æ–Ω (–ø–æ–ª–æ–≤–∏–Ω–Ω—ã–π —É—Ä–æ–Ω, —É–º–Ω–æ–∂–µ–Ω–Ω—ã–π –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)
          const enemyDamageArea = (damageArea / 2) * HIERARCHY_DAMAGE_FACTOR;

          if (urQuanSphere && urQuanSphere.size > 0) {
            const urQuanArea = Math.PI * Math.pow(urQuanSphere.size, 2);
            const newUrQuanArea = Math.max(0, urQuanArea - enemyDamageArea);
            urQuanSphere.size = Math.sqrt(newUrQuanArea / Math.PI);

            // –£–¥–∞–ª—è–µ–º Ur-Quan, –µ—Å–ª–∏ —Ä–∞–¥–∏—É—Å —Å—Ç–∞–ª 0
            if (urQuanSphere.size <= 0) {
              const index = gameSpheres.findIndex(sphere => sphere.name === 'Ur-Quan');
              if (index !== -1) {
                console.log("–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ Ur-Quan");
                gameSpheres.splice(index, 1);
              }
            }
          }

          if (kohrAhSphere && kohrAhSphere.size > 0) {
            const kohrAhArea = Math.PI * Math.pow(kohrAhSphere.size, 2);
            const newKohrAhArea = Math.max(0, kohrAhArea - enemyDamageArea);
            kohrAhSphere.size = Math.sqrt(newKohrAhArea / Math.PI);

            // –£–¥–∞–ª—è–µ–º Kohr-Ah, –µ—Å–ª–∏ —Ä–∞–¥–∏—É—Å —Å—Ç–∞–ª 0
            if (kohrAhSphere.size <= 0) {
              const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
              if (index !== -1) {
                console.log("–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ Kohr-Ah");
                gameSpheres.splice(index, 1);
              }
            }
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ —Ä–∞–¥–∏—É—Å —Å–æ—é–∑–Ω–∏–∫–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º –ø–æ—Å–ª–µ –±–æ—è
          if (allySphere.size < MIN_ALLY_RADIUS) {
            allySphere.size = MIN_ALLY_RADIUS; // –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
            ally.phase = 'returning';
          }
        }
        else if (ally.phase === 'returning') {
          // –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
          const dx = ally.originalPosition.x - allySphere.x;
          const dy = ally.originalPosition.y - allySphere.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
            allySphere.x = ally.originalPosition.x;
            allySphere.y = ally.originalPosition.y;
            ally.phase = 'returned';
          } else {
            const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
            const ratio = moveDistance / distance;
            allySphere.x += dx * ratio;
            allySphere.y += dy * ratio;
          }
        }

        if (ally.phase !== 'returned' && ally.phase !== 'destroyed') {
          activeAllies++;
        }
      }

      // –ï—Å–ª–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤ –∏–ª–∏ –≤—Å–µ –≤—Ä–∞–≥–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º –∞—Ç–∞–∫—É
      if (activeAllies === 0 ||
          ((!kohrAhSphere || kohrAhSphere.size <= 0) &&
           (!urQuanSphere || urQuanSphere.size <= 0))) {

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Å–æ—é–∑–Ω–∏–∫–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∏–ª–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã
        let allReturnedOrDestroyed = true;
        for (const ally of allianceAttackState.alliesInAttack) {
          if (ally.phase !== 'returned' && ally.phase !== 'destroyed') {
            allReturnedOrDestroyed = false;
            break;
          }
        }

        if (allReturnedOrDestroyed) {
          allianceAttackState.active = false;
          console.log("–ê—Ç–∞–∫–∞ –ê–ª—å—è–Ω—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤—Ä–∞–≥–∏ –ø–æ—Å–ª–µ –∞—Ç–∞–∫–∏
          const remainingKohrAh = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');
          const remainingUrQuan = gameSpheres.find(sphere => sphere.name === 'Ur-Quan');

          // –ï—Å–ª–∏ –≤—Ä–∞–≥–∏ –æ—Å—Ç–∞–ª–∏—Å—å –∏ –º–∞—Ä—à —Å–º–µ—Ä—Ç–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω, –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—á–µ—Ç
          if ((remainingKohrAh || remainingUrQuan) && deathMarchState.warningShown) {
            deathMarchState.countdownActive = true;
            console.log("–í—Ä–∞–≥–∏ –æ—Å—Ç–∞–ª–∏—Å—å, –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—á–µ—Ç –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏");
          }
        }
      }

      allianceAttackState.daysInCurrentPhase += DAYS_PER_TURN;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞
    function nextTurn() {
      currentDate.setDate(currentDate.getDate() + DAYS_PER_TURN);
      updateDateDisplay();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –±–µ–≥—Å—Ç–≤–æ Spathi
      checkAutoSpathiEscape();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Pkunk
      checkAutoPkunkReunion();

      modifySphereRadius('Ur-Quan', UR_QUAN_RADIUS_CHANGE * DAYS_PER_TURN);
      modifySphereRadius('Kohr-Ah', KOHR_AH_RADIUS_CHANGE * DAYS_PER_TURN);
      modifySphereRadius('Shofixti', SHOFIXTI_RADIUS_CHANGE * DAYS_PER_TURN);

      const mmrnmhrmSphere = gameSpheres.find(sphere => sphere.name === 'Mmrnmhrm');
      if (mmrnmhrmSphere) {
          const currentArea = Math.PI * Math.pow(mmrnmhrmSphere.size, 2);
          const newArea = currentArea + (MMRNMHRM_AREA_CHANGE * DAYS_PER_TURN);
          mmrnmhrmSphere.size = Math.sqrt(newArea / Math.PI);
      }

const createNewAlliance = document.getElementById('createNewAlliance').checked;
if (createNewAlliance) {
    createEarthlingAndNewAllianceSpheres();
    const checkbox = document.getElementById('createNewAlliance');
    checkbox.checked = false;
    checkbox.disabled = true;
    document.querySelector('label[for="createNewAlliance"]').classList.add('completed');

    const checkboxesToUnlock = [
        'allianceWithZoqFotPik', 'allianceWithOrz', 'allianceWithSpathi',
        'allianceWithThraddash', 'syreenFleetReturn', 'shofixtiRevival', 'ilwrathAttack'
    ];

    checkboxesToUnlock.forEach(checkboxId => {
        const cb = document.getElementById(checkboxId);
        const label = document.querySelector(`label[for="${checkboxId}"]`);
        if (cb && label) {
            cb.disabled = false;
            label.style.color = '';
            label.style.fontStyle = '';
        }
    });

    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–±–æ–∫—Å "–ê—Ç–∞–∫–∞ –ê–ª—å—è–Ω—Å–∞"
    const allianceAttackCheckbox = document.getElementById('allianceAttack');
    const allianceAttackLabel = document.querySelector('label[for="allianceAttack"]');
    if (allianceAttackCheckbox && allianceAttackLabel) {
        allianceAttackCheckbox.disabled = false;
        allianceAttackLabel.style.color = '';
        allianceAttackLabel.style.fontStyle = '';
    }
}

      const allianceWithZoqFotPik = document.getElementById('allianceWithZoqFotPik').checked;
      if (allianceWithZoqFotPik) {
        createZoqFotPikAlliance();
        const checkbox = document.getElementById('allianceWithZoqFotPik');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithZoqFotPik"]').classList.add('completed');
      }

      const allianceWithOrz = document.getElementById('allianceWithOrz').checked;
      if (allianceWithOrz) {
        createOrzAlliance();
        const checkbox = document.getElementById('allianceWithOrz');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithOrz"]').classList.add('completed');
      }

      const allianceWithSpathi = document.getElementById('allianceWithSpathi').checked;
      if (allianceWithSpathi) {
        createSpathiAlliance();
        const checkbox = document.getElementById('allianceWithSpathi');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithSpathi"]').classList.add('completed');
      }

      const allianceWithBlackSquadron = document.getElementById('allianceWithBlackSquadron').checked;
      if (allianceWithBlackSquadron) {
        createBlackSquadronAlliance();
        const checkbox = document.getElementById('allianceWithBlackSquadron');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithBlackSquadron"]').classList.add('completed');

        const motherArkCheckbox = document.getElementById('motherArkRepair');
        const motherArkLabel = document.querySelector('label[for="motherArkRepair"]');
        if (motherArkCheckbox && motherArkLabel) {
            motherArkCheckbox.disabled = false;
            motherArkLabel.style.color = '';
            motherArkLabel.style.fontStyle = '';
        }
      }

      const motherArkRepair = document.getElementById('motherArkRepair').checked;
      if (motherArkRepair) {
        createMotherArkRepair();
        const checkbox = document.getElementById('motherArkRepair');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="motherArkRepair"]').classList.add('completed');
      }

      const allianceWithThraddash = document.getElementById('allianceWithThraddash').checked;
      if (allianceWithThraddash) {
        createThraddashAlliance();
        const checkbox = document.getElementById('allianceWithThraddash');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithThraddash"]').classList.add('completed');

        const thraddashAttackCheckbox = document.getElementById('thraddashAttack');
        const thraddashAttackLabel = document.querySelector('label[for="thraddashAttack"]');
        if (thraddashAttackCheckbox && thraddashAttackLabel) {
            thraddashAttackCheckbox.disabled = false;
            thraddashAttackLabel.style.color = '';
            thraddashAttackLabel.style.fontStyle = '';
        }

        const supoxUtwigAllianceCheckbox = document.getElementById('allianceWithSupoxUtwig');
        const supoxUtwigAllianceLabel = document.querySelector('label[for="allianceWithSupoxUtwig"]');
        if (supoxUtwigAllianceCheckbox && supoxUtwigAllianceLabel) {
            supoxUtwigAllianceCheckbox.disabled = false;
            supoxUtwigAllianceLabel.style.color = '';
            supoxUtwigAllianceLabel.style.fontStyle = '';
        }
      }

      const syreenFleetReturn = document.getElementById('syreenFleetReturn').checked;
      if (syreenFleetReturn) {
          createSyreenFleetReturn();
          const checkbox = document.getElementById('syreenFleetReturn');
          checkbox.checked = false;
          checkbox.disabled = true;
          document.querySelector('label[for="syreenFleetReturn"]').classList.add('completed');

          const myconAmbushCheckbox = document.getElementById('myconAmbush');
          const myconAmbushLabel = document.querySelector('label[for="myconAmbush"]');
          if (myconAmbushCheckbox && myconAmbushLabel) {
              myconAmbushCheckbox.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–±–æ–∫—Å
              myconAmbushLabel.style.color = ''; // –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
              myconAmbushLabel.style.fontStyle = ''; // –£–±—Ä–∞—Ç—å –∫—É—Ä—Å–∏–≤
          }
      }

      const earthlingShieldRemoval = document.getElementById('earthlingShieldRemoval').checked;
      if (earthlingShieldRemoval) {
          const earthlingSphere = gameSpheres.find(sphere => sphere.name === 'Earthling');
          if (earthlingSphere) {
              earthlingSphere.size += EARTHLING_SHIELD_REMOVAL_RADIUS_INCREASE;
          }

          const checkbox = document.getElementById('earthlingShieldRemoval');
          checkbox.checked = false;
          checkbox.disabled = true;
          document.querySelector('label[for="earthlingShieldRemoval"]').classList.add('completed');
      }

      const unzervaltShieldRemoval = document.getElementById('unzervaltShieldRemoval').checked;
      if (unzervaltShieldRemoval) {
          createUnzervaltShieldRemoval();
          const checkbox = document.getElementById('unzervaltShieldRemoval');
          checkbox.checked = false;
          checkbox.disabled = true;
          document.querySelector('label[for="unzervaltShieldRemoval"]').classList.add('completed');
      }

      const syreenShieldRemoval = document.getElementById('syreenShieldRemoval').checked;
      if (syreenShieldRemoval) {
          const syreenSphere = gameSpheres.find(sphere => sphere.name === 'Syreen');
          if (syreenSphere) {
              syreenSphere.size += SYREEN_SHIELD_REMOVAL_RADIUS_INCREASE;
          }

          const checkbox = document.getElementById('syreenShieldRemoval');
          checkbox.checked = false;
          checkbox.disabled = true;
          document.querySelector('label[for="syreenShieldRemoval"]').classList.add('completed');
      }

      const spathiShieldRemoval = document.getElementById('spathiShieldRemoval').checked;
      if (spathiShieldRemoval) {
          createSpathiShieldRemoval();
          const checkbox = document.getElementById('spathiShieldRemoval');
          checkbox.checked = false;
          checkbox.disabled = true;
          document.querySelector('label[for="spathiShieldRemoval"]').classList.add('completed');
      }

      const allianceWithSupoxUtwig = document.getElementById('allianceWithSupoxUtwig').checked;
      if (allianceWithSupoxUtwig) {
        createSupoxUtwigAlliance();
        const checkbox = document.getElementById('allianceWithSupoxUtwig');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithSupoxUtwig"]').classList.add('completed');

        const supoxUtwigAttackCheckbox = document.getElementById('supoxUtwigAttack');
        const supoxUtwigAttackLabel = document.querySelector('label[for="supoxUtwigAttack"]');
        if (supoxUtwigAttackCheckbox && supoxUtwigAttackLabel) {
            supoxUtwigAttackCheckbox.disabled = false;
            supoxUtwigAttackLabel.style.color = '';
            supoxUtwigAttackLabel.style.fontStyle = '';
        }
      }

      const shofixtiRevival = document.getElementById('shofixtiRevival').checked;
      if (shofixtiRevival) {
        createShofixtiRevival();
        const checkbox = document.getElementById('shofixtiRevival');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="shofixtiRevival"]').classList.add('completed');

        const yehatRebellionCheckbox = document.getElementById('yehatRebellion');
        const yehatRebellionLabel = document.querySelector('label[for="yehatRebellion"]');
        if (yehatRebellionCheckbox && yehatRebellionLabel) {
            yehatRebellionCheckbox.disabled = false;
            yehatRebellionLabel.style.color = '';
            yehatRebellionLabel.style.fontStyle = '';
        }
      }

      const yehatRebellion = document.getElementById('yehatRebellion').checked;
      if (yehatRebellion) {
        createYehatRebellion();
        const checkbox = document.getElementById('yehatRebellion');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="yehatRebellion"]').classList.add('completed');

        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —Ä–µ–≤–æ–ª—é—Ü–∏–∏ Yehat –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk
        yehatRebellionDate = new Date(currentDate);
      }

      const allianceWithChmmr = document.getElementById('allianceWithChmmr').checked;
      if (allianceWithChmmr) {
        createChmmrAlliance();
        const checkbox = document.getElementById('allianceWithChmmr');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceWithChmmr"]').classList.add('completed');

        const shieldsToUnlock = [
            'earthlingShieldRemoval',
            'unzervaltShieldRemoval',
            'syreenShieldRemoval',
            'spathiShieldRemoval'
        ];

        shieldsToUnlock.forEach(shieldId => {
            const shieldCheckbox = document.getElementById(shieldId);
            const shieldLabel = document.querySelector(`label[for="${shieldId}"]`);
            if (shieldCheckbox && shieldLabel) {
                shieldCheckbox.disabled = false;
                shieldLabel.style.color = '';
                shieldLabel.style.fontStyle = '';
            }
        });
      }

      const thraddashAttack = document.getElementById('thraddashAttack').checked;
      if (thraddashAttack && !thraddashAttackState.active) {
        startThraddashAttack();
        const checkbox = document.getElementById('thraddashAttack');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="thraddashAttack"]').classList.add('completed');
      }

      const ilwrathAttack = document.getElementById('ilwrathAttack').checked;
      if (ilwrathAttack && !ilwrathAttackState.active) {
        startIlwrathAttack();
        const checkbox = document.getElementById('ilwrathAttack');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="ilwrathAttack"]').classList.add('completed');
      }

      const supoxUtwigAttack = document.getElementById('supoxUtwigAttack').checked;
      if (supoxUtwigAttack && !supoxUtwigAttackState.active) {
        startSupoxUtwigAttack();
        const checkbox = document.getElementById('supoxUtwigAttack');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="supoxUtwigAttack"]').classList.add('completed');
      }

      const myconAmbush = document.getElementById('myconAmbush').checked;
      if (myconAmbush && !myconAmbushState.active) {
        startMyconAmbush();
        const checkbox = document.getElementById('myconAmbush');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="myconAmbush"]').classList.add('completed');

        const chmmrAllianceCheckbox = document.getElementById('allianceWithChmmr');
        const chmmrAllianceLabel = document.querySelector('label[for="allianceWithChmmr"]');
        if (chmmrAllianceCheckbox && chmmrAllianceLabel) {
            chmmrAllianceCheckbox.disabled = false;
            chmmrAllianceLabel.style.color = '';
            chmmrAllianceLabel.style.fontStyle = '';
        }
      }

      const allianceAttack = document.getElementById('allianceAttack').checked;
      if (allianceAttack && !allianceAttackState.active) {
        startAllianceAttack();
        const checkbox = document.getElementById('allianceAttack');
        checkbox.checked = false;
        checkbox.disabled = true;
        document.querySelector('label[for="allianceAttack"]').classList.add('completed');
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –º–∞—Ä—à–∞ —Å–º–µ—Ä—Ç–∏
      checkDeathMarchConditions();

      if (thraddashAttackState.active) {
        processThraddashAttack();
      }

      if (ilwrathAttackState.active) {
        processIlwrathAttack();
      }

      if (supoxUtwigAttackState.active) {
        processSupoxUtwigAttack();
      }

      if (myconAmbushState.active) {
        processMyconAmbush();
      }

      if (pkunkReunionState.active) {
        processPkunkReunion();
      }

      if (allianceAttackState.active) {
        processAllianceAttack();
      }

      // –£–¥–∞–ª—è–µ–º —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã–µ —Å—Ñ–µ—Ä—ã
      removeDestroyedSpheres();

      updateNewAllianceSphere();
      renderAll(currentHighlight);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–∞ —Å—Ñ–µ—Ä—ã
    function modifySphereRadius(sphereName, radiusChange) {
      for (const sphere of gameSpheres) {
        if (sphere.name === sphereName) {
          sphere.size += radiusChange;
          if (sphere.size < 0) sphere.size = 0;

          // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º —Å—Ñ–µ—Ä—É, –µ—Å–ª–∏ —Ä–∞–¥–∏—É—Å —Å—Ç–∞–ª 0
          if (sphere.size === 0) {
            const index = gameSpheres.indexOf(sphere);
            if (index !== -1) {
              console.log(`–£–¥–∞–ª–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ ${sphereName} —Å –Ω—É–ª–µ–≤—ã–º —Ä–∞–¥–∏—É—Å–æ–º`);
              gameSpheres.splice(index, 1);
            }
          }
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Spathi Slave Shield - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    function createSpathiShieldRemoval() {
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ñ–µ—Ä—É Spathi, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        const existingSpathiIndex = gameSpheres.findIndex(sphere => sphere.name === 'Spathi');
        if (existingSpathiIndex !== -1) {
            gameSpheres.splice(existingSpathiIndex, 1);
        }

        // –ù–∞—Ö–æ–¥–∏–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Spathi –∏–∑ –Ω–æ–≤—ã—Ö —Å—Ñ–µ—Ä
        const spathiFromNewSpheres = initialSphereData.newSpheres.find(sphere => sphere.name === 'Spathi');

        if (spathiFromNewSpheres) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ñ–µ—Ä—É —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏, –Ω–æ —Å —Ä–∞–¥–∏—É—Å–æ–º SPATHI_SLAVE_SHIELD_RADIUS
            const spathiShieldSphere = {
                name: 'Spathi',
                x: spathiFromNewSpheres.x,
                y: spathiFromNewSpheres.y,
                size: SPATHI_SLAVE_SHIELD_RADIUS,
                color: spathiFromNewSpheres.color
            };

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ñ–µ—Ä—É –≤ –∏–≥—Ä–æ–≤—ã–µ —Å—Ñ–µ—Ä—ã
            gameSpheres.push(spathiShieldSphere);

            // –î–æ–±–∞–≤–ª—è–µ–º Spathi –≤ —Å–æ—é–∑–Ω–∏–∫–∏ New Alliance
            newAllianceAllies.Spathi = true;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—É –∞–ª—å—è–Ω—Å–∞, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –±–µ–≥—Å—Ç–≤–æ
            spathiAllianceDate = null;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ñ–µ—Ä—É New Alliance
            updateNewAllianceSphere();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Unzervalt Slave Shield
    function createUnzervaltShieldRemoval() {
        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç Umgah –∏–∑ —Å—Ç–∞—Ä—ã—Ö —Å—Ñ–µ—Ä –≤–ª–∏—è–Ω–∏—è
        const umgahFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Umgah');
        const umgahColor = umgahFromSC1 ? umgahFromSC1.color : '#8A2BE2'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

        // –°–æ–∑–¥–∞–µ–º —Å—Ñ–µ—Ä—É Unzervalt
        const unzervaltSphere = {
            name: UNZERVALT_SPHERE_NAME,
            x: UNZERVALT_CENTER_POSITION[0],
            y: UNZERVALT_CENTER_POSITION[1],
            size: UNZERVALT_SLAVE_SHIELD_RADIUS,
            color: umgahColor
        };

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ñ–µ—Ä—É –≤ –∏–≥—Ä–æ–≤—ã–µ —Å—Ñ–µ—Ä—ã
        gameSpheres.push(unzervaltSphere);

        // –î–æ–±–∞–≤–ª—è–µ–º Unzervalt –≤ —Å–æ—é–∑–Ω–∏–∫–∏ New Alliance
        newAllianceAllies.Unzervalt = true;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ñ–µ—Ä—É New Alliance
        updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–≤–æ–ª—é—Ü–∏–∏ Yehat
    function createYehatRebellion() {
      const existingYehatSphere = gameSpheres.find(sphere => sphere.name === 'Yehat');
      if (existingYehatSphere) {
        existingYehatSphere.size = YEHAY_REBEL_RADIUS;
      }

      const yehatFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Yehat');

      if (yehatFromSC1) {
        const newYehatRebelSphere = {
          name: 'Yehat Rebel',
          x: yehatFromSC1.x + 10,
          y: yehatFromSC1.y,
          size: YEHAY_REBEL_RADIUS,
          color: yehatFromSC1.color
        };

        gameSpheres.push(newYehatRebelSphere);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk
    function startPkunkReunion() {
      const pkunkSphere = gameSpheres.find(sphere => sphere.name === 'Pkunk');
      const yehatSphere = gameSpheres.find(sphere => sphere.name === 'Yehat');

      if (!pkunkSphere || !yehatSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ñ–µ—Ä—ã Pkunk –∏–ª–∏ Yehat –¥–ª—è –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        return;
      }

      pkunkReunionState.active = true;
      pkunkReunionState.phase = 'moving';
      pkunkReunionState.daysInCurrentPhase = 0;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Pkunk
    function processPkunkReunion() {
      const pkunkIndex = gameSpheres.findIndex(sphere => sphere.name === 'Pkunk');
      const yehatIndex = gameSpheres.findIndex(sphere => sphere.name === 'Yehat');
      const yehatRebelIndex = gameSpheres.findIndex(sphere => sphere.name === 'Yehat Rebel');

      if (pkunkIndex === -1 || yehatIndex === -1 || yehatRebelIndex === -1) {
        pkunkReunionState.active = false;
        return;
      }

      const pkunkSphere = gameSpheres[pkunkIndex];
      const yehatSphere = gameSpheres[yehatIndex];
      const yehatRebelSphere = gameSpheres[yehatRebelIndex];

      pkunkReunionState.daysInCurrentPhase += DAYS_PER_TURN;

      if (pkunkReunionState.phase === 'moving') {
        const dx = yehatSphere.x - pkunkSphere.x;
        const dy = yehatSphere.y - pkunkSphere.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
          pkunkSphere.x = yehatSphere.x;
          pkunkSphere.y = yehatSphere.y;
          pkunkReunionState.phase = 'completed';
          pkunkReunionState.daysInCurrentPhase = 0;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distance;
          pkunkSphere.x += dx * ratio;
          pkunkSphere.y += dy * ratio;
        }
      } else if (pkunkReunionState.phase === 'completed') {
        gameSpheres.splice(pkunkIndex, 1);

        const newYehatIndex = gameSpheres.findIndex(sphere => sphere.name === 'Yehat');
        if (newYehatIndex !== -1) {
          gameSpheres.splice(newYehatIndex, 1);
        }

        yehatRebelSphere.size = YEHAY_REBEL_AFTER_REUNION_RADIUS;
        newAllianceAllies.YehatRebel = true;
        updateNewAllianceSphere();
        pkunkReunionState.active = false;
      }
    }

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–≥—Å—Ç–≤–∞ Spathi
function createSpathiEscape() {
  newAllianceAllies.Spathi = false;

  const spathiIndex = gameSpheres.findIndex(sphere => sphere.name === 'Spathi');
  if (spathiIndex !== -1) {
    gameSpheres.splice(spathiIndex, 1);
  }

  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∞–ª—å—è–Ω—Å —Å Black Squadron
  const blackSquadronCheckbox = document.getElementById('allianceWithBlackSquadron');
  const blackSquadronLabel = document.querySelector('label[for="allianceWithBlackSquadron"]');
  if (blackSquadronCheckbox && blackSquadronLabel) {
    blackSquadronCheckbox.disabled = false;
    blackSquadronLabel.style.color = '';
    blackSquadronLabel.style.fontStyle = '';
  }
}

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Spathi
    function createSpathiAlliance() {
      newAllianceAllies.Spathi = true;

      // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –∑–∞–∫–ª—é—á–µ–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Spathi
      spathiAllianceDate = new Date(currentDate);

      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ç–∞–∫–∏ Thraddash
    function startThraddashAttack() {
      const thraddashSphere = gameSpheres.find(sphere => sphere.name === 'Thraddash');
      const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');

      if (!thraddashSphere || !kohrAhSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ñ–µ—Ä—ã Thraddash –∏–ª–∏ Kohr-Ah –¥–ª—è –∞—Ç–∞–∫–∏");
        return;
      }

      thraddashAttackState.active = true;
      thraddashAttackState.phase = 'moving';
      thraddashAttackState.originalThraddashPosition = {
        x: thraddashSphere.x,
        y: thraddashSphere.y
      };
      thraddashAttackState.daysInCurrentPhase = 0;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ç–∞–∫–∏ Thraddash
    function processThraddashAttack() {
      const thraddashIndex = gameSpheres.findIndex(sphere => sphere.name === 'Thraddash');
      const kohrAhIndex = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');

      if (thraddashIndex === -1 || kohrAhIndex === -1) {
        thraddashAttackState.active = false;
        return;
      }

      const thraddashSphere = gameSpheres[thraddashIndex];
      const kohrAhSphere = gameSpheres[kohrAhIndex];

      if (thraddashSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Thraddash');
        if (index !== -1) gameSpheres.splice(index, 1);
        thraddashAttackState.active = false;
        newAllianceAllies.Thraddash = false;
        return;
      }

      if (kohrAhSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
        if (index !== -1) gameSpheres.splice(index, 1);
        thraddashAttackState.active = false;
        return;
      }

      thraddashAttackState.daysInCurrentPhase += DAYS_PER_TURN;

      if (thraddashAttackState.phase === 'moving') {
        const dx = kohrAhSphere.x - thraddashSphere.x;
        const dy = kohrAhSphere.y - thraddashSphere.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= THRADDASH_ATTACK_DISTANCE) {
          thraddashAttackState.phase = 'fighting';
          thraddashAttackState.daysInCurrentPhase = 0;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distance;
          thraddashSphere.x += dx * ratio;
          thraddashSphere.y += dy * ratio;
        }
      } else if (thraddashAttackState.phase === 'fighting') {
        const thraddashArea = Math.PI * Math.pow(thraddashSphere.size, 2);
        const kohrAhArea = Math.PI * Math.pow(kohrAhSphere.size, 2);

        const damageArea = SPHERE_DAMAGE_SPEED * DAYS_PER_TURN;

        const newThraddashArea = Math.max(0, thraddashArea - damageArea);
        const newKohrAhArea = Math.max(0, kohrAhArea - damageArea);

        thraddashSphere.size = Math.sqrt(newThraddashArea / Math.PI);
        kohrAhSphere.size = Math.sqrt(newKohrAhArea / Math.PI);

        if (thraddashSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Thraddash');
          if (index !== -1) gameSpheres.splice(index, 1);
          thraddashAttackState.active = false;
          newAllianceAllies.Thraddash = false;
          return;
        }

        if (kohrAhSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
          if (index !== -1) gameSpheres.splice(index, 1);
          thraddashAttackState.active = false;
          return;
        }

        if (thraddashSphere.size <= THRADDASH_ATTACK_DAMAGE) {
          thraddashAttackState.phase = 'returning';
          thraddashAttackState.daysInCurrentPhase = 0;
        }
      } else if (thraddashAttackState.phase === 'returning') {
        const dx = thraddashAttackState.originalThraddashPosition.x - thraddashSphere.x;
        const dy = thraddashAttackState.originalThraddashPosition.y - thraddashSphere.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
          thraddashSphere.x = thraddashAttackState.originalThraddashPosition.x;
          thraddashSphere.y = thraddashAttackState.originalThraddashPosition.y;
          thraddashAttackState.active = false;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distance;
          thraddashSphere.x += dx * ratio;
          thraddashSphere.y += dy * ratio;
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ç–∞–∫–∏ Ilwrath
    function startIlwrathAttack() {
      const ilwrathSphere = gameSpheres.find(sphere => sphere.name === 'Ilwrath');
      const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');

      if (!ilwrathSphere || !kohrAhSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ñ–µ—Ä—ã Ilwrath –∏–ª–∏ Kohr-Ah –¥–ª—è –∞—Ç–∞–∫–∏");
        return;
      }

      ilwrathAttackState.active = true;
      ilwrathAttackState.phase = 'moving';
      ilwrathAttackState.originalIlwrathPosition = {
        x: ilwrathSphere.x,
        y: ilwrathSphere.y
      };
      ilwrathAttackState.daysInCurrentPhase = 0;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ç–∞–∫–∏ Ilwrath
    function processIlwrathAttack() {
      const ilwrathIndex = gameSpheres.findIndex(sphere => sphere.name === 'Ilwrath');
      const kohrAhIndex = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
      const urQuanIndex = gameSpheres.findIndex(sphere => sphere.name === 'Ur-Quan');

      if (ilwrathIndex === -1 || kohrAhIndex === -1) {
        ilwrathAttackState.active = false;
        return;
      }

      const ilwrathSphere = gameSpheres[ilwrathIndex];
      const kohrAhSphere = gameSpheres[kohrAhIndex];
      const urQuanSphere = urQuanIndex !== -1 ? gameSpheres[urQuanIndex] : null;

      if (ilwrathSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Ilwrath');
        if (index !== -1) gameSpheres.splice(index, 1);
        ilwrathAttackState.active = false;
        return;
      }

      if (kohrAhSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
        if (index !== -1) gameSpheres.splice(index, 1);
        ilwrathAttackState.active = false;
        return;
      }

      ilwrathAttackState.daysInCurrentPhase += DAYS_PER_TURN;

      if (ilwrathAttackState.phase === 'moving') {
        const dx = kohrAhSphere.x - ilwrathSphere.x;
        const dy = kohrAhSphere.y - ilwrathSphere.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= ILWRATH_ATTACK_DISTANCE) {
          ilwrathAttackState.phase = 'fighting';
          ilwrathAttackState.daysInCurrentPhase = 0;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distance;
          ilwrathSphere.x += dx * ratio;
          ilwrathSphere.y += dy * ratio;
        }
      } else if (ilwrathAttackState.phase === 'fighting') {
        const ilwrathArea = Math.PI * Math.pow(ilwrathSphere.size, 2);
        const kohrAhArea = Math.PI * Math.pow(kohrAhSphere.size, 2);
        const urQuanArea = urQuanSphere ? Math.PI * Math.pow(urQuanSphere.size, 2) : 0;

        const damageArea = SPHERE_DAMAGE_SPEED * DAYS_PER_TURN;

        const newIlwrathArea = Math.max(0, ilwrathArea - damageArea);
        const newKohrAhArea = Math.max(0, kohrAhArea - (damageArea / 2));
        const newUrQuanArea = urQuanSphere ? Math.max(0, urQuanArea - (damageArea / 2)) : 0;

        ilwrathSphere.size = Math.sqrt(newIlwrathArea / Math.PI);
        kohrAhSphere.size = Math.sqrt(newKohrAhArea / Math.PI);
        if (urQuanSphere) {
          urQuanSphere.size = Math.sqrt(newUrQuanArea / Math.PI);
        }

        if (ilwrathSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Ilwrath');
          if (index !== -1) gameSpheres.splice(index, 1);
          ilwrathAttackState.active = false;
          return;
        }

        if (kohrAhSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
          if (index !== -1) gameSpheres.splice(index, 1);
          ilwrathAttackState.active = false;
          return;
        }

        if (urQuanSphere && urQuanSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Ur-Quan');
          if (index !== -1) gameSpheres.splice(index, 1);
        }

        if (ilwrathSphere.size <= ILWRATH_ATTACK_DAMAGE) {
          ilwrathAttackState.phase = 'returning';
          ilwrathAttackState.daysInCurrentPhase = 0;
        }
      } else if (ilwrathAttackState.phase === 'returning') {
        const dx = ilwrathAttackState.originalIlwrathPosition.x - ilwrathSphere.x;
        const dy = ilwrathAttackState.originalIlwrathPosition.y - ilwrathSphere.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
          ilwrathSphere.x = ilwrathAttackState.originalIlwrathPosition.x;
          ilwrathSphere.y = ilwrathAttackState.originalIlwrathPosition.y;
          ilwrathAttackState.active = false;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distance;
          ilwrathSphere.x += dx * ratio;
          ilwrathSphere.y += dy * ratio;
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ç–∞–∫–∏ Supox –∏ Utwig
    function startSupoxUtwigAttack() {
      const supoxSphere = gameSpheres.find(sphere => sphere.name === 'Supox');
      const utwigSphere = gameSpheres.find(sphere => sphere.name === 'Utwig');
      const kohrAhSphere = gameSpheres.find(sphere => sphere.name === 'Kohr-Ah');

      if (!supoxSphere || !utwigSphere || !kohrAhSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ñ–µ—Ä—ã Supox, Utwig –∏–ª–∏ Kohr-Ah –¥–ª—è –∞—Ç–∞–∫–∏");
        return;
      }

      supoxUtwigAttackState.active = true;
      supoxUtwigAttackState.phase = 'moving';
      supoxUtwigAttackState.originalSupoxPosition = {
        x: supoxSphere.x,
        y: supoxSphere.y
      };
      supoxUtwigAttackState.originalUtwigPosition = {
        x: utwigSphere.x,
        y: utwigSphere.y
      };
      supoxUtwigAttackState.daysInCurrentPhase = 0;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ç–∞–∫–∏ Supox –∏ Utwig
    function processSupoxUtwigAttack() {
      const supoxIndex = gameSpheres.findIndex(sphere => sphere.name === 'Supox');
      const utwigIndex = gameSpheres.findIndex(sphere => sphere.name === 'Utwig');
      const kohrAhIndex = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');

      if (supoxIndex === -1 || utwigIndex === -1 || kohrAhIndex === -1) {
        supoxUtwigAttackState.active = false;
        return;
      }

      const supoxSphere = gameSpheres[supoxIndex];
      const utwigSphere = gameSpheres[utwigIndex];
      const kohrAhSphere = gameSpheres[kohrAhIndex];

      if (supoxSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Supox');
        if (index !== -1) gameSpheres.splice(index, 1);
        supoxUtwigAttackState.active = false;
        return;
      }

      if (utwigSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Utwig');
        if (index !== -1) gameSpheres.splice(index, 1);
        supoxUtwigAttackState.active = false;
        return;
      }

      if (kohrAhSphere.size <= 0) {
        const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
        if (index !== -1) gameSpheres.splice(index, 1);
        supoxUtwigAttackState.active = false;
        return;
      }

      supoxUtwigAttackState.daysInCurrentPhase += DAYS_PER_TURN;

      if (supoxUtwigAttackState.phase === 'moving') {
        const dxToKohrAh = kohrAhSphere.x - supoxSphere.x;
        const dyToKohrAh = kohrAhSphere.y - supoxSphere.y;
        const distanceToKohrAh = Math.sqrt(dxToKohrAh * dxToKohrAh + dyToKohrAh * dyToKohrAh);

        if (distanceToKohrAh <= SUPOX_UTWIG_ATTACK_DISTANCE) {
          supoxUtwigAttackState.phase = 'fighting';
          supoxUtwigAttackState.daysInCurrentPhase = 0;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
          const ratio = moveDistance / distanceToKohrAh;

          supoxSphere.x += dxToKohrAh * ratio;
          supoxSphere.y += dyToKohrAh * ratio;

          utwigSphere.x += dxToKohrAh * ratio;
          utwigSphere.y += dyToKohrAh * ratio;
        }
      } else if (supoxUtwigAttackState.phase === 'fighting') {
        const supoxArea = Math.PI * Math.pow(supoxSphere.size, 2);
        const utwigArea = Math.PI * Math.pow(utwigSphere.size, 2);
        const kohrAhArea = Math.PI * Math.pow(kohrAhSphere.size, 2);

        const damageArea = SPHERE_DAMAGE_SPEED * DAYS_PER_TURN;

        const newUtwigArea = Math.max(0, utwigArea - damageArea);
        const newKohrAhArea = Math.max(0, kohrAhArea - damageArea);
        const newSupoxArea = Math.max(0, supoxArea - (damageArea / SUPOX_DAMAGE_REDUCTION_FACTOR));

        supoxSphere.size = Math.sqrt(newSupoxArea / Math.PI);
        utwigSphere.size = Math.sqrt(newUtwigArea / Math.PI);
        kohrAhSphere.size = Math.sqrt(newKohrAhArea / Math.PI);

        if (supoxSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Supox');
          if (index !== -1) gameSpheres.splice(index, 1);
          supoxUtwigAttackState.active = false;
          return;
        }

        if (utwigSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Utwig');
          if (index !== -1) gameSpheres.splice(index, 1);
          supoxUtwigAttackState.active = false;
          return;
        }

        if (kohrAhSphere.size <= 0) {
          const index = gameSpheres.findIndex(sphere => sphere.name === 'Kohr-Ah');
          if (index !== -1) gameSpheres.splice(index, 1);
          supoxUtwigAttackState.active = false;
          return;
        }

        if (utwigSphere.size <= SUPOX_UTWIG_ATTACK_DAMAGE) {
          supoxUtwigAttackState.phase = 'returning';
          supoxUtwigAttackState.daysInCurrentPhase = 0;
        }
      } else if (supoxUtwigAttackState.phase === 'returning') {
        const dxToOriginalSupox = supoxUtwigAttackState.originalSupoxPosition.x - supoxSphere.x;
        const dyToOriginalSupox = supoxUtwigAttackState.originalSupoxPosition.y - supoxSphere.y;
        const distanceToOriginalSupox = Math.sqrt(dxToOriginalSupox * dxToOriginalSupox + dyToOriginalSupox * dyToOriginalSupox);

        const dxToOriginalUtwig = supoxUtwigAttackState.originalUtwigPosition.x - utwigSphere.x;
        const dyToOriginalUtwig = supoxUtwigAttackState.originalUtwigPosition.y - utwigSphere.y;
        const distanceToOriginalUtwig = Math.sqrt(dxToOriginalUtwig * dxToOriginalUtwig + dyToOriginalUtwig * dyToOriginalUtwig);

        if (distanceToOriginalSupox <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN &&
            distanceToOriginalUtwig <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
          supoxSphere.x = supoxUtwigAttackState.originalSupoxPosition.x;
          supoxSphere.y = supoxUtwigAttackState.originalSupoxPosition.y;
          utwigSphere.x = supoxUtwigAttackState.originalUtwigPosition.x;
          utwigSphere.y = supoxUtwigAttackState.originalUtwigPosition.y;
          supoxUtwigAttackState.active = false;
        } else {
          const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;

          if (distanceToOriginalSupox > 0) {
            const ratioSupox = moveDistance / distanceToOriginalSupox;
            supoxSphere.x += dxToOriginalSupox * ratioSupox;
            supoxSphere.y += dyToOriginalSupox * ratioSupox;
          }

          if (distanceToOriginalUtwig > 0) {
            const ratioUtwig = moveDistance / distanceToOriginalUtwig;
            utwigSphere.x += dxToOriginalUtwig * ratioUtwig;
            utwigSphere.y += dyToOriginalUtwig * ratioUtwig;
          }
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞—Å–∞–¥—ã Mycon
    function startMyconAmbush() {
      const myconSphere = gameSpheres.find(sphere => sphere.name === 'Mycon');

      if (!myconSphere) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ñ–µ—Ä–∞ Mycon –¥–ª—è –∑–∞—Å–∞–¥—ã");
        return;
      }

      myconAmbushState.active = true;
      myconAmbushState.phase = 'moving';
      myconAmbushState.originalMyconPosition = {
        x: myconSphere.x,
        y: myconSphere.y
      };
      myconAmbushState.daysInCurrentPhase = 0;
    }

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—Å–∞–¥—ã Mycon
function processMyconAmbush() {
  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ñ–µ—Ä—ã Mycon –≤ –º–∞—Å—Å–∏–≤–µ
  const myconIndex = gameSpheres.findIndex(sphere => sphere.name === 'Mycon');
  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ñ–µ—Ä—ã Syreen –≤ –º–∞—Å—Å–∏–≤–µ
  const syreenIndex = gameSpheres.findIndex(sphere => sphere.name === 'Syreen');

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ñ–µ—Ä–∞ Mycon
  if (myconIndex === -1) {
    myconAmbushState.active = false;
    return;
  }

  const myconSphere = gameSpheres[myconIndex];
  const syreenSphere = syreenIndex !== -1 ? gameSpheres[syreenIndex] : null;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞ –ª–∏ —Å—Ñ–µ—Ä–∞
  if (myconSphere.size <= 0) {
    const index = gameSpheres.findIndex(sphere => sphere.name === 'Mycon');
    if (index !== -1) gameSpheres.splice(index, 1);
    myconAmbushState.active = false;
    return;
  }

  myconAmbushState.daysInCurrentPhase += DAYS_PER_TURN;

  if (myconAmbushState.phase === 'moving') {
    // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ (Organon)
    const dx = MYCON_AMBUSH_TARGET[0] - myconSphere.x;
    const dy = MYCON_AMBUSH_TARGET[1] - myconSphere.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
      // –î–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∞–∑–µ –±–æ—è
      myconSphere.x = MYCON_AMBUSH_TARGET[0];
      myconSphere.y = MYCON_AMBUSH_TARGET[1];
      myconAmbushState.phase = 'fighting';
      myconAmbushState.daysInCurrentPhase = 0;
    } else {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
      const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
      const ratio = moveDistance / distance;
      myconSphere.x += dx * ratio;
      myconSphere.y += dy * ratio;
    }
  } else if (myconAmbushState.phase === 'fighting') {
    // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–ª–æ—â–∞–¥—å Mycon
    const myconArea = Math.PI * Math.pow(myconSphere.size, 2);
    const damageArea = SPHERE_DAMAGE_SPEED * DAYS_PER_TURN;

    // –£–º–µ–Ω—å—à–∞–µ–º –ø–ª–æ—â–∞–¥—å Mycon
    const newMyconArea = Math.max(0, myconArea - damageArea);

    // –í–´–ß–ò–°–õ–Ø–ï–ú –ø–ª–æ—â–∞–¥—å, –∫–æ—Ç–æ—Ä—É—é –ø–æ—Ç–µ—Ä—è–ª Mycon
    const lostMyconArea = myconArea - newMyconArea;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä Mycon
    myconSphere.size = Math.sqrt(newMyconArea / Math.PI);

    // –ï–°–õ–ò –°–§–ï–†–ê SYREEN –°–£–©–ï–°–¢–í–£–ï–¢, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ—ë –ø–ª–æ—â–∞–¥—å –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–π –ø–ª–æ—â–∞–¥–∏ Mycon
    if (syreenSphere && lostMyconArea > 0) {
      const syreenArea = Math.PI * Math.pow(syreenSphere.size, 2);
      const newSyreenArea = syreenArea + (lostMyconArea / 2);
      syreenSphere.size = Math.sqrt(newSyreenArea / Math.PI);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞ –ª–∏ —Å—Ñ–µ—Ä–∞ –ø–æ—Å–ª–µ –±–æ—è
    if (myconSphere.size <= 0) {
      const index = gameSpheres.findIndex(sphere => sphere.name === 'Mycon');
      if (index !== -1) gameSpheres.splice(index, 1);
      myconAmbushState.active = false;
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ —Ä–∞–¥–∏—É—Å Mycon –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π
    if (myconSphere.size <= MYCON_AMBUSH_DAMAGE) {
      myconAmbushState.phase = 'returning';
      myconAmbushState.daysInCurrentPhase = 0;
    }
  } else if (myconAmbushState.phase === 'returning') {
    // –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    const dx = myconAmbushState.originalMyconPosition.x - myconSphere.x;
    const dy = myconAmbushState.originalMyconPosition.y - myconSphere.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance <= SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN) {
      // –î–æ—Å—Ç–∏–≥–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
      myconSphere.x = myconAmbushState.originalMyconPosition.x;
      myconSphere.y = myconAmbushState.originalMyconPosition.y;

      // === –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–¨–Ø–ù–° –° SYREEN ===
      newAllianceAllies.Syreen = true; // –î–æ–±–∞–≤–ª—è–µ–º Syreen –≤ —Å–æ—é–∑–Ω–∏–∫–∏
      updateNewAllianceSphere(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ñ–µ—Ä—É –ù–æ–≤–æ–≥–æ –ê–ª—å—è–Ω—Å–∞

      myconAmbushState.active = false; // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞—Å–∞–¥—É
    } else {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
      const moveDistance = SPHERE_MOVEMENT_SPEED * DAYS_PER_TURN;
      const ratio = moveDistance / distance;
      myconSphere.x += dx * ratio;
      myconSphere.y += dy * ratio;
    }
  }
}

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ñ–µ—Ä Earthling –∏ New Alliance
    function createEarthlingAndNewAllianceSpheres() {
      const earthlingFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Earthling');

      if (earthlingFromSC1) {
        const earthlingSphere = {
          name: 'Earthling',
          x: earthlingFromSC1.x,
          y: earthlingFromSC1.y,
          size: EARTHLING_INITIAL_RADIUS,
          color: COLOR_EARTHLING
        };

        const newAllianceSphere = {
          name: NEW_ALLIANCE_NAME,
          x: earthlingFromSC1.x,
          y: earthlingFromSC1.y,
          size: NEW_ALLIANCE_INITIAL_RADIUS,
          color: COLOR_NEW_ALLIANCE
        };

        gameSpheres.push(earthlingSphere);
        gameSpheres.push(newAllianceSphere);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Zoq-Fot-Pik
    function createZoqFotPikAlliance() {
      newAllianceAllies.ZoqFotPik = true;
      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Orz
    function createOrzAlliance() {
      newAllianceAllies.Orz = true;
      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Thraddash
    function createThraddashAlliance() {
      newAllianceAllies.Thraddash = true;
      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ñ–ª–æ—Ç–∞ Syreen (—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ñ–µ—Ä—ã)
    function createSyreenFleetReturn() {
      const spathiFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Vux');

      const newSyreenSphere = {
        name: 'Syreen',
        x: SYREEN_INITIAL_POSITION[0],
        y: SYREEN_INITIAL_POSITION[1],
        size: SYREEN_INITIAL_RADIUS,
        color: spathiFromSC1 ? spathiFromSC1.color : '#FFFFFF'
      };

      gameSpheres.push(newSyreenSphere);
      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Supox –∏ Utwig
    function createSupoxUtwigAlliance() {
      newAllianceAllies.SupoxUtwig = true;
      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è Shofixti
    function createShofixtiRevival() {
      newAllianceAllies.Shofixti = true;

      const shofixtiFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Shofixti');

      if (shofixtiFromSC1) {
        const newShofixtiSphere = {
          name: 'Shofixti',
          x: shofixtiFromSC1.x,
          y: shofixtiFromSC1.y,
          size: SHOFIXTI_REVIVED_RADIUS,
          color: shofixtiFromSC1.color
        };

        gameSpheres.push(newShofixtiSphere);
      }

      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Chmmr
    function createChmmrAlliance() {
      newAllianceAllies.Chmmr = true;

      const chenjesuFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Chenjesu');

      if (chenjesuFromSC1) {
        const newChmmrSphere = {
          name: 'Chmmr',
          x: chenjesuFromSC1.x,
          y: chenjesuFromSC1.y,
          size: CHMMR_INITIAL_RADIUS,
          color: chenjesuFromSC1.color
        };

        gameSpheres.push(newChmmrSphere);
      }

      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Black Squadron
    function createBlackSquadronAlliance() {
      newAllianceAllies.BlackSquadron = true;

      const spathiFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Spathi');

      if (spathiFromSC1) {
        const newBlackSquadronSphere = {
          name: BLACK_SQUADRON_NAME,
          x: spathiFromSC1.x,
          y: spathiFromSC1.y,
          size: spathiFromSC1.size,
          color: COLOR_BLACK_SQUADRON
        };

        gameSpheres.push(newBlackSquadronSphere);
      }

      updateNewAllianceSphere();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—á–∏–Ω–∫–∏ Mother-Ark –∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞ —Å Mmrnmhrm
    function createMotherArkRepair() {
      newAllianceAllies.Mmrnmhrm = true;

      const mmrnmhrmFromSC1 = initialSphereData.oldSpheres.find(sphere => sphere.name === 'Mmrnmhrm');

      if (mmrnmhrmFromSC1) {
        const newMmrnmhrmSphere = {
          name: 'Mmrnmhrm',
          x: mmrnmhrmFromSC1.x,
          y: mmrnmhrmFromSC1.y,
          size: MMRNMHRM_REVIVED_RADIUS,
          color: mmrnmhrmFromSC1.color
        };

        gameSpheres.push(newMmrnmhrmSphere);
      }

      updateNewAllianceSphere();
    }

    function hexToRgba(hex, a=1){
      const h = String(hex || '#000000').replace('#','');
      const n = parseInt(h,16) || 0;
      return `rgba(${(n>>16)&255},${(n>>8)&255},${n&255},${a})`;
    }

    function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
    const sizeMap = {'Dwarf':3,'Giant':6,'Super-Giant':10};

    const rawNamed = (Array.isArray(window.namedStars) && window.namedStars.length) ? window.namedStars : [];

    function isValidColor(c){ return Object.keys(colors).includes(c); }
    function isValidSize(s){ return Object.keys(sizeMap).includes(s); }

    const stars = rawNamed.map(entry => {
      const [x,y,color,sizeLabel,letter,constellation] = Array.isArray(entry) ? entry : [];
      const nx = clamp(Number(x) || 0, 0, BASE_MAP_SIZE) / BASE_MAP_SIZE;
      const ny = clamp(Number(y) || 0, 0, BASE_MAP_SIZE) / BASE_MAP_SIZE;
      const c = isValidColor(color) ? color : 'White';
      const s = isValidSize(sizeLabel) ? sizeLabel : 'Dwarf';
      return {
        xNorm: nx,
        yNorm: ny,
        color: c,
        sizeLabel: s,
        letter: letter || '',
        constellation: constellation || '',
        baseSize: sizeMap[s],
        colorHex: (colors[c] && colors[c][0]) || '#FFFFFF'
      };
    });

    const canvas = document.getElementById('starMap');
    const ctx = canvas.getContext('2d');
    const mapContainer = document.getElementById('mapContainer');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
    function updateCanvasSize() {
      const containerWidth = mapContainer.clientWidth;
      const containerHeight = mapContainer.clientHeight;

      const prevScale = scale;
      const prevOffsetX = offsetX;
      const prevOffsetY = offsetY;

      canvas.width = containerWidth;
      canvas.height = containerHeight;

      scale = prevScale;
      offsetX = prevOffsetX;
      offsetY = prevOffsetY;

      renderAll(currentHighlight);
    }

    function drawGrid(){
      ctx.strokeStyle='lightgray';
      ctx.lineWidth=0.5;
      const stepX = BASE_MAP_SIZE / GRID_DIVISIONS;
      const stepY = BASE_MAP_SIZE / GRID_DIVISIONS;
      for(let x=0;x<=BASE_MAP_SIZE;x+=stepX){
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,BASE_MAP_SIZE);
        ctx.stroke();
      }
      for(let y=0;y<=BASE_MAP_SIZE;y+=stepY){
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(BASE_MAP_SIZE, y);
        ctx.stroke();
      }
    }

    function drawStarAtPixel(px,py,size,colorHex,highlight=false){
      const cx = Number(px);
      const cy = Number(py);
      const outer = Math.max(3, size * (highlight ? STAR_HIGHLIGHT_MULTIPLIER : STAR_NORMAL_MULTIPLIER));
      const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, outer);
      g.addColorStop(0, hexToRgba(colorHex,1));
      g.addColorStop(0.25, hexToRgba(colorHex,0.7));
      g.addColorStop(0.6, hexToRgba(colorHex,0.15));
      g.addColorStop(1, hexToRgba('#000000',0));
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(cx, cy, outer, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = colorHex || '#FFFFFF';
      ctx.beginPath();
      ctx.arc(cx, cy, Math.max(0.6, size * (highlight ? 1.25 : 1)), 0, Math.PI*2);
      ctx.fill();
    }

    function drawStarLabel(logicalX, logicalY, letter, constellation, scale) {
    const screenX = logicalX * scale + offsetX;
    const screenY = logicalY * scale + offsetY;

    const screenCenterX = canvas.width / 2;
    const screenCenterY = canvas.height / 2;

    const offset = STAR_LABEL_OFFSET;

    let textAlign = 'left';
    let textBaseline = 'bottom';
    let textX = screenX + offset;
    let textY = screenY - offset;

    const isLeft = screenX < screenCenterX;
    const isTop = screenY < screenCenterY;

    if (isLeft) {
        textAlign = 'left';
        textX = screenX + offset;
    } else {
        textAlign = 'right';
        textX = screenX - offset;
    }

    if (isTop) {
        textBaseline = 'top';
        textY = screenY + offset;
    } else {
        textBaseline = 'bottom';
        textY = screenY - offset;
    }

    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.font = '20px sans-serif';
    ctx.textAlign = textAlign;
    ctx.textBaseline = textBaseline;
    ctx.fillText(`${letter} ${constellation}`, textX, textY);
    ctx.restore();
}

    function drawTextAlongArc(ctx, text, centerX, centerY, radius, angle) {
      const totalWidth = ctx.measureText(text).width;
      const avgCharWidth = totalWidth / text.length;

      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const charPosition = (i - (text.length - 1) / 2);
        const charAngle = angle + (charPosition * (avgCharWidth / radius));

        const x = centerX + Math.cos(charAngle) * radius;
        const y = centerY + Math.sin(charAngle) * radius;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(charAngle + Math.PI / 2);
        ctx.fillText(char, 0, 0);
        ctx.restore();
      }

      ctx.restore();
    }

    function normToPixel(xNorm, yNorm){
      return {
        x: xNorm * BASE_MAP_SIZE,
        y: (1 - yNorm) * BASE_MAP_SIZE
      };
    }

    function getTextPosition(centerXNorm, centerYNorm, radius) {
      const positionType = document.getElementById('textPosition').value;

      if (positionType === 'auto') {
        const centerX = centerXNorm * BASE_MAP_SIZE;
        const centerY = centerYNorm * BASE_MAP_SIZE;

        const leftEdge = centerX - radius;
        const rightEdge = centerX + radius;
        const topEdge = centerY - radius;
        const bottomEdge = centerY + radius;

        const isLeftCropped = leftEdge < 0;
        const isRightCropped = rightEdge > BASE_MAP_SIZE;
        const isTopCropped = topEdge < 0;
        const isBottomCropped = bottomEdge > BASE_MAP_SIZE;

        if (isLeftCropped && !isRightCropped) {
          return -Math.PI/2 + Math.PI/4;
        } else if (isRightCropped && !isLeftCropped) {
          return -Math.PI/2 - Math.PI/4;
        } else {
          return -Math.PI/2;
        }
      }

      if (positionType === 'counterclockwise') {
        return -Math.PI/2 - Math.PI/4;
      } else if (positionType === 'clockwise') {
        return -Math.PI/2 + Math.PI/4;
      } else {
        return -Math.PI/2;
      }
    }

    function drawInfluenceSphere(centerXNorm, centerYNorm, radius, colorHex, name = null) {
      const center = normToLogicalPixel(centerXNorm, centerYNorm);

      ctx.save();
      ctx.strokeStyle = hexToRgba(colorHex, 0.7);
      ctx.fillStyle = hexToRgba(colorHex, 0.1);
      ctx.lineWidth = 2 / scale;

      ctx.beginPath();
      ctx.arc(center.x, center.y, radius, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      if (name && name.trim() !== "") {
        ctx.save();
        ctx.fillStyle = colorHex;
        ctx.font = 'bold ' + (24 / scale) + 'px Arial';

        const textAngle = getTextPosition(centerXNorm, centerYNorm, radius);

        drawTextAlongArc(ctx, name, center.x, center.y, radius + SPHERE_LABEL_OFFSET, textAngle);

        ctx.restore();
      }
    }

    function normToLogicalPixel(xNorm, yNorm){
      const p = normToPixel(xNorm, yNorm);
      return { x: p.x, y: p.y };
    }

    function logicalWidth(){ return BASE_MAP_SIZE; }
    function logicalHeight(){ return BASE_MAP_SIZE; }

    function screenToLogical(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const sx = (clientX - rect.left) * (canvas.width / rect.width);
      const sy = (clientY - rect.top) * (canvas.height / rect.height);
      return { x: (sx - offsetX) / scale, y: (sy - offsetY) / scale };
    }

    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let currentHighlight = -1;

    let renderAll = function(highlightIndex = -1){
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const containerWidth = canvas.width;
      const containerHeight = canvas.height;
      const aspectRatio = containerWidth / containerHeight;
      const mapAspectRatio = BASE_MAP_SIZE / BASE_MAP_SIZE;

      let renderScale = scale;
      let renderOffsetX = offsetX;
      let renderOffsetY = offsetY;

      if (scale === 1 && offsetX === 0 && offsetY === 0) {
        if (aspectRatio > mapAspectRatio) {
          renderScale = containerHeight / BASE_MAP_SIZE;
          renderOffsetX = (containerWidth - BASE_MAP_SIZE * renderScale) / 2;
        } else {
          renderScale = containerWidth / BASE_MAP_SIZE;
          renderOffsetY = (containerHeight - BASE_MAP_SIZE * renderScale) / 2;
        }

        scale = renderScale;
        offsetX = renderOffsetX;
        offsetY = renderOffsetY;
      }

      ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);

      ctx.fillStyle = 'black';
      ctx.fillRect(0,0, logicalWidth()/scale, logicalHeight()/scale);

      ctx.save();
      ctx.lineWidth = 0.5 / scale;
      ctx.strokeStyle = 'lightgray';
      const stepX = logicalWidth() / GRID_DIVISIONS;
      const stepY = logicalHeight() / GRID_DIVISIONS;
      for(let x=0;x<=logicalWidth(); x+=stepX){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x, logicalHeight()); ctx.stroke();
      }
      for(let y=0;y<=logicalHeight(); y+=stepY){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(logicalWidth(), y); ctx.stroke();
      }
      ctx.restore();

      ctx.save();
      ctx.beginPath();
      ctx.rect(0, 0, BASE_MAP_SIZE, BASE_MAP_SIZE);
      ctx.clip();

      const sphereType = document.getElementById('sphereType').value;

      // ========== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–§–ï–† ==========
      if (sphereType === 'newSpheres') {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ —Å—Ñ–µ—Ä—ã (–∏–∑–º–µ–Ω—è–µ–º—ã–µ)
        for (const sphere of gameSpheres) {
          if (!sphere.name && !sphere.color && sphere.x === 0 && sphere.y === 0 && sphere.size === 0) continue;

          const xNorm = sphere.x / BASE_MAP_SIZE;
          const yNorm = sphere.y / BASE_MAP_SIZE;

          const color = sphere.color || '#FFFFFF';

          drawInfluenceSphere(xNorm, yNorm, sphere.size, color, sphere.name);
        }
      } else if (sphereType === 'initialNewSpheres') {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Å—Ñ–µ—Ä—ã Star Control 2 (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ)
        for (const sphere of initialSphereData.newSpheres) {
          if (!sphere.name && !sphere.color && sphere.x === 0 && sphere.y === 0 && sphere.size === 0) continue;

          const xNorm = sphere.x / BASE_MAP_SIZE;
          const yNorm = sphere.y / BASE_MAP_SIZE;

          const color = sphere.color || '#FFFFFF';

          drawInfluenceSphere(xNorm, yNorm, sphere.size, color, sphere.name);
        }
      } else if (sphereType === 'oldSpheres') {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ñ–µ—Ä—ã (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ)
        for (const sphere of initialSphereData.oldSpheres) {
          if (!sphere.name && !sphere.color && sphere.x === 0 && sphere.y === 0 && sphere.size === 0) continue;

          const xNorm = sphere.x / BASE_MAP_SIZE;
          const yNorm = sphere.y / BASE_MAP_SIZE;

          const color = sphere.color || '#FFFFFF';

          drawInfluenceSphere(xNorm, yNorm, sphere.size, color, sphere.name);
        }
      }
      // –î–ª—è 'none' –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º

      const indices = stars.map((_,i)=>i);
      indices.sort((a,b)=>{
        const sa = stars[a].baseSize, sb = stars[b].baseSize;
        return sb - sa;
      });

      for(let idx of indices){
        const s = stars[idx];
        const p = normToLogicalPixel(s.xNorm, s.yNorm);
        const scaleForSize = canvas.height / BASE_MAP_SIZE;
        const computedSize = Math.max(1, s.baseSize * scaleForSize);
        const isHighlight = (idx === highlightIndex);
        drawStarAtPixel(p.x, p.y, computedSize, s.colorHex, isHighlight);
      }

      if(highlightIndex >= 0 && stars[highlightIndex]){
        const s = stars[highlightIndex];
        const p = normToLogicalPixel(s.xNorm, s.yNorm);
        drawStarLabel(p.x, p.y, s.letter, s.constellation, scale);
      }

      ctx.restore();

      ctx.setTransform(1,0,0,1,0,0);
    };

    function findStarAtLogical(x, y, radius = STAR_HOVER_RADIUS) {
      let best = -1;
      let bestDist2 = radius * radius;

      for(let i = 0; i < stars.length; i++) {
        const s = stars[i];
        const p = normToLogicalPixel(s.xNorm, s.yNorm);
        const dx = p.x - x;
        const dy = p.y - y;
        const d2 = dx*dx + dy*dy;

        if(d2 <= bestDist2) {
          bestDist2 = d2;
          best = i;
        }
      }

      return best;
    }

    canvas.addEventListener('mousemove', (e)=>{
      const logical = screenToLogical(e.clientX, e.clientY);
      const found = findStarAtLogical(logical.x, logical.y, STAR_HOVER_RADIUS/scale);

      if(found !== currentHighlight) {
        currentHighlight = found;
        renderAll(currentHighlight);
      }
    });

    canvas.addEventListener('mouseleave', ()=>{
      currentHighlight = -1;
      renderAll(-1);
    });

    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let panOffsetStart = { x: 0, y: 0 };

    canvas.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return;
      isPanning = true;
      const rect = canvas.getBoundingClientRect();
      panStart.x = (e.clientX - rect.left) * (canvas.width / rect.width);
      panStart.y = (e.clientY - rect.top) * (canvas.height / rect.height);
      panOffsetStart.x = offsetX;
      panOffsetStart.y = offsetY;
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      const rect = canvas.getBoundingClientRect();
      const curX = (e.clientX - rect.left) * (canvas.width / rect.width);
      const curY = (e.clientY - rect.top) * (canvas.height / rect.height);
      offsetX = panOffsetStart.x + (curX - panStart.x);
      offsetY = panOffsetStart.y + (curY - panStart.y);
      renderAll(currentHighlight);
    });

    window.addEventListener('mouseup', (e) => {
      if (e.button !== 0) return;
      if (!isPanning) return;
      isPanning = false;
    });

    canvas.addEventListener('mouseleave', () => {
    });

    canvas.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
      const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);

      const delta = e.deltaY;
      const factor = 1 - delta * ZOOM_STEP;
      const newScale = clamp(scale * factor, MIN_SCALE, MAX_SCALE);
      const actualFactor = newScale / scale;

      offsetX = mouseX - (mouseX - offsetX) * actualFactor;
      offsetY = mouseY - (mouseY - offsetY) * actualFactor;

      scale = newScale;
      renderAll(currentHighlight);
    }, { passive: false });

    document.getElementById('sphereType').addEventListener('change', () => {
      renderAll(currentHighlight);
    });

    document.getElementById('textPosition').addEventListener('change', () => {
      renderAll(currentHighlight);
    });

    document.getElementById('nextTurnButton').addEventListener('click', nextTurn);

    window.addEventListener('resize', () => {
      updateCanvasSize();
    });

    window.addEventListener('load', () => {
        updateCanvasSize();
        updateDateDisplay();
        initializeCheckboxes();
    });
  </script>
</body>
</html>
